<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The BriteSide â€” Internal Newsletter</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><polygon points='50,5 63,38 98,38 69,59 80,95 50,72 20,95 31,59 2,38 37,38' fill='%23FE8916'/></svg>">
    <!-- BritePulse SDK -->
    <script src="https://britepulse-api-29820647719.us-central1.run.app/sdk.js"
            data-api-key="pk_19ae847f-1641-4d40-ad73-30ba88aa8ce9_9d7e23d74b9141eb8b7c4fe9c1651d1c"
            data-api-url="https://britepulse-api-29820647719.us-central1.run.app"
            data-widget-position="bottom-right"
            data-capture-errors="true"
            data-capture-network-errors="true"
            defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css">
    <style>
        /* ============================================
           RESET & BASE
           ============================================ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #018181 0%, #272d3f 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* ============================================
           CONTAINER
           ============================================ */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: visible;
        }

        /* ============================================
           HEADER
           ============================================ */
        .header {
            background: #272d3f;
            color: white;
            padding: 32px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 16px 16px 0 0;
            position: relative;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .header-logo {
            width: 44px;
            height: 44px;
            background: #018181;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 800;
            color: white;
            letter-spacing: -1px;
            flex-shrink: 0;
        }
        .header-title-group {
            display: flex;
            flex-direction: column;
        }
        .header h1 {
            font-size: 26px;
            font-weight: 700;
            line-height: 1.2;
        }
        .header h1 .sparkle {
            color: #FE8916;
        }
        .header .subtitle {
            font-size: 13px;
            color: rgba(255,255,255,0.55);
            margin-top: 2px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .start-over-btn {
            background: #FE8916;
            color: white;
            border: none;
            padding: 8px 18px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .start-over-btn:hover { background: #e57a0e; }
        .header-user-greeting {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            font-weight: 500;
        }

        /* ============================================
           PROGRESS BAR
           ============================================ */
        .progress-container {
            margin: 0 40px 20px 40px;
            padding-top: 20px;
        }
        .progress-text {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
            color: #4b5563;
        }
        .progress-step-text {
            font-weight: 600;
            color: #018181;
        }
        .progress-label {
            color: #6b7280;
        }
        .progress {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar {
            background: #018181;
            height: 100%;
            width: 0%;
            transition: width 0.4s ease;
            border-radius: 4px;
        }

        /* ============================================
           STEPS
           ============================================ */
        .step {
            padding: 40px;
            display: none;
        }
        .step.active {
            display: block;
        }
        .step h2 {
            color: #272d3f;
            font-size: 28px;
            margin-bottom: 8px;
        }
        .step > p.step-description {
            color: #666;
            margin-bottom: 30px;
            font-size: 15px;
            line-height: 1.5;
        }

        /* ============================================
           BUTTONS
           ============================================ */
        .btn {
            background: #018181;
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover {
            background: #016666;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(1,129,129,0.3);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary {
            background: #6b7280;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .btn-orange {
            background: #FE8916;
        }
        .btn-orange:hover {
            background: #e57a0e;
        }
        .btn-green {
            background: #059669;
        }
        .btn-green:hover {
            background: #047857;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-small {
            background: #018181;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-small:hover { background: #016666; }
        .btn-small:disabled { background: #ccc; cursor: not-allowed; }
        .buttons {
            display: flex;
            gap: 12px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        /* ============================================
           LOADING / SPINNER
           ============================================ */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }
        .spinner {
            width: 44px;
            height: 44px;
            border: 4px solid #e5e7eb;
            border-top-color: #018181;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text {
            font-size: 14px;
            color: #6b7280;
        }

        /* ============================================
           FORM ELEMENTS
           ============================================ */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #272d3f;
            font-size: 14px;
        }
        .form-group textarea,
        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="email"],
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        .form-group textarea:focus,
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #018181;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .form-group .helper-text {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 4px;
        }

        /* ============================================
           STEP 1: MONTH GRID
           ============================================ */
        .month-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin: 24px 0;
        }
        .month-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .month-card:hover {
            border-color: #018181;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(1,129,129,0.12);
        }
        .month-card.selected {
            background: #018181;
            border-color: #018181;
            color: white;
        }
        .month-card .month-name {
            font-weight: 600;
            font-size: 16px;
        }
        .month-card .month-emoji {
            font-size: 24px;
            display: block;
            margin-bottom: 8px;
        }
        .birthday-count-badge {
            display: inline-block;
            margin-top: 16px;
            padding: 8px 20px;
            background: #FFF8F0;
            border: 2px solid #FE8916;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: #272d3f;
        }

        /* ============================================
           STEP 2: JOKE CARDS
           ============================================ */
        .theme-selector {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .theme-selector .form-group {
            flex: 1;
            min-width: 200px;
            margin-bottom: 0;
        }
        .joke-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }
        .joke-card {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 18px 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            gap: 14px;
            align-items: flex-start;
        }
        .joke-card:hover {
            border-color: #018181;
            background: #fafafa;
        }
        .joke-card.selected {
            border-color: #018181;
            background: #F0FAFA;
            box-shadow: 0 0 0 3px rgba(1,129,129,0.15);
        }
        .joke-number {
            background: #018181;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
        }
        .joke-text {
            font-size: 15px;
            line-height: 1.5;
            color: #333;
        }
        .custom-joke-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #018181;
        }
        .custom-joke-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #018181;
        }
        .custom-joke-area {
            display: none;
            margin-top: 12px;
        }
        .custom-joke-area.visible {
            display: block;
        }

        /* ============================================
           STEP 3: BIRTHDAY CARDS
           ============================================ */
        .birthday-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin: 20px 0;
        }
        .birthday-card {
            background: #FFF8F0;
            border: 2px solid #f3e8d8;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }
        .birthday-icon {
            font-size: 32px;
            flex-shrink: 0;
        }
        .birthday-info {
            flex: 1;
        }
        .birthday-name {
            font-size: 17px;
            font-weight: 700;
            color: #272d3f;
            margin-bottom: 2px;
        }
        .birthday-meta {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 10px;
        }
        .birthday-message-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
            min-height: 44px;
            transition: border-color 0.2s;
        }
        .birthday-message-input:focus {
            outline: none;
            border-color: #018181;
        }
        .no-birthdays {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        .no-birthdays .no-birthday-icon {
            font-size: 56px;
            margin-bottom: 16px;
            display: block;
        }
        .no-birthdays .no-birthday-title {
            font-size: 18px;
            font-weight: 600;
            color: #272d3f;
            margin-bottom: 8px;
        }
        .no-birthdays .no-birthday-text {
            font-size: 14px;
            line-height: 1.5;
        }

        /* ============================================
           STEP 4: SPOTLIGHT
           ============================================ */
        .spotlight-employee-info {
            background: #F0FAFA;
            border: 2px solid #cce7e7;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        .spotlight-employee-info.visible {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        .spotlight-avatar {
            width: 56px;
            height: 56px;
            background: #018181;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }
        .spotlight-details h3 {
            font-size: 18px;
            color: #272d3f;
            margin-bottom: 2px;
        }
        .spotlight-details .spotlight-role {
            font-size: 14px;
            color: #018181;
            font-weight: 500;
        }
        .spotlight-details .spotlight-dept {
            font-size: 13px;
            color: #6b7280;
        }
        .spotlight-optional-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .ai-blurb-container {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
            display: none;
        }
        .ai-blurb-container.visible {
            display: block;
        }
        .ai-blurb-container h4 {
            font-size: 14px;
            color: #018181;
            margin-bottom: 10px;
            font-weight: 600;
        }

        /* ============================================
           STEP 5: UPDATES
           ============================================ */
        .update-block {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
            position: relative;
        }
        .update-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .update-block-header h3 {
            font-size: 16px;
            color: #272d3f;
        }
        .remove-update-btn {
            background: none;
            border: 1px solid #dc3545;
            color: #dc3545;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .remove-update-btn:hover {
            background: #dc3545;
            color: white;
        }
        .add-update-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #018181;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            padding: 8px 0;
            transition: color 0.2s;
        }
        .add-update-link:hover {
            color: #016666;
            text-decoration: underline;
        }

        /* ============================================
           STEP 6: SPECIAL SECTION
           ============================================ */
        .toggle-row {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 0;
        }
        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            flex-shrink: 0;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #ccc;
            border-radius: 28px;
            transition: 0.3s;
        }
        .toggle-slider:before {
            content: "";
            position: absolute;
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        .toggle-switch input:checked + .toggle-slider {
            background: #018181;
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        .toggle-label {
            font-size: 16px;
            font-weight: 600;
            color: #272d3f;
        }
        .toggle-helper {
            font-size: 13px;
            color: #9ca3af;
            margin-top: 4px;
        }
        .special-section-fields {
            display: none;
            margin-top: 16px;
            padding: 24px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
        }
        .special-section-fields.visible {
            display: block;
        }

        /* ============================================
           STEP 4: WELCOME NEW HIRES
           ============================================ */
        .welcome-hire-card {
            background: #F0FAFA;
            border: 2px solid #cce7e7;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }
        .welcome-hire-fields {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .welcome-hire-fields .full-width {
            grid-column: 1 / -1;
        }
        .welcome-hire-fields input {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            width: 100%;
        }
        .welcome-hire-fields input:focus {
            outline: none;
            border-color: #018181;
        }
        .welcome-remove-btn {
            background: none;
            border: 1px solid #dc3545;
            color: #dc3545;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            flex-shrink: 0;
            align-self: flex-start;
        }
        .welcome-remove-btn:hover { background: #dc3545; color: white; }

        /* ============================================
           SPOTLIGHT BLOCK (multi)
           ============================================ */
        .spotlight-block {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
        }
        .spotlight-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .spotlight-block-header h3 {
            font-size: 16px;
            color: #272d3f;
        }

        /* ============================================
           CROPPER MODAL
           ============================================ */
        .cropper-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cropper-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow: auto;
        }
        .cropper-modal-content h3 {
            margin-bottom: 16px;
            color: #272d3f;
        }
        .cropper-modal-content img {
            max-width: 100%;
            display: block;
        }
        .cropper-modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            justify-content: flex-end;
        }
        .cropper-aspect-row {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            margin-bottom: 12px;
        }
        .cropper-aspect-btn {
            padding: 6px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .cropper-aspect-btn.active {
            border-color: #018181;
            background: #F0FAFA;
            color: #018181;
        }

        /* ============================================
           UPLOAD BUTTON & PREVIEW
           ============================================ */
        .upload-area {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .upload-btn-label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #018181;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .upload-btn-label:hover { background: #016666; }
        .upload-preview-thumb {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e5e7eb;
        }
        .upload-remove {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ============================================
           GAME SECTION
           ============================================ */
        .game-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin: 16px 0;
        }
        .game-type-card {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .game-type-card:hover { border-color: #018181; background: #fafafa; }
        .game-type-card.selected { border-color: #018181; background: #F0FAFA; }
        .game-type-card .game-icon { font-size: 28px; display: block; margin-bottom: 6px; }
        .game-type-card .game-label { font-size: 13px; font-weight: 600; }
        .game-preview-area {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
        }
        .game-canvas-container {
            text-align: center;
            margin: 16px 0;
        }
        .game-canvas-container canvas {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            max-width: 100%;
        }

        /* ============================================
           RECIPIENT SEARCH
           ============================================ */
        .recipient-search {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .recipient-search input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }
        .recipient-search input:focus {
            outline: none;
            border-color: #018181;
        }

        /* ============================================
           STEP 9: PREVIEW (was 7)
           ============================================ */
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .subject-line-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 14px 18px;
        }
        .subject-line-label {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: #6b7280;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }
        .subject-line-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 600;
            color: #272d3f;
            font-family: inherit;
            outline: none;
        }
        .subject-line-edit {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .subject-line-edit:hover { opacity: 1; }
        .preview-frame {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            background: #f5f5f5;
        }
        .preview-frame iframe {
            width: 100%;
            min-height: 600px;
            border: none;
            display: block;
        }
        .preview-loading {
            text-align: center;
            padding: 80px 20px;
            color: #6b7280;
        }

        /* ============================================
           STEP 10: SEND (was 8)
           ============================================ */
        .recipient-section {
            margin-bottom: 24px;
        }
        .recipient-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .recipient-count {
            font-size: 14px;
            color: #018181;
            font-weight: 600;
        }
        .select-all-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
        }
        .select-all-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #018181;
        }
        .select-all-row label {
            font-weight: 600;
            font-size: 14px;
            color: #272d3f;
            cursor: pointer;
        }
        .recipient-list {
            max-height: 320px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 8px 0;
        }
        .recipient-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            font-size: 14px;
            transition: background 0.15s;
        }
        .recipient-item:hover {
            background: #f9fafb;
        }
        .recipient-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #018181;
            flex-shrink: 0;
        }
        .recipient-name {
            font-weight: 600;
            color: #272d3f;
        }
        .recipient-email {
            color: #6b7280;
            font-size: 13px;
        }
        .manual-recipient-row {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            padding: 16px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
        }
        .manual-recipient-row input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }
        .manual-recipient-row input:focus {
            outline: none;
            border-color: #018181;
        }

        /* ============================================
           SUCCESS SCREEN
           ============================================ */
        .success-screen {
            display: none;
            text-align: center;
            padding: 80px 40px;
        }
        .success-screen.visible {
            display: block;
        }
        .success-icon {
            font-size: 80px;
            margin-bottom: 20px;
            display: block;
            animation: successPop 0.5s ease;
        }
        @keyframes successPop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        .success-title {
            font-size: 32px;
            font-weight: 700;
            color: #272d3f;
            margin-bottom: 8px;
        }
        .success-subtitle {
            font-size: 18px;
            color: #6b7280;
            margin-bottom: 32px;
        }
        .confetti-bar {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
        }
        .confetti-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: confettiBounce 0.6s ease infinite alternate;
        }
        .confetti-dot:nth-child(1) { background: #018181; animation-delay: 0s; }
        .confetti-dot:nth-child(2) { background: #FE8916; animation-delay: 0.1s; }
        .confetti-dot:nth-child(3) { background: #059669; animation-delay: 0.2s; }
        .confetti-dot:nth-child(4) { background: #3b82f6; animation-delay: 0.3s; }
        .confetti-dot:nth-child(5) { background: #ec4899; animation-delay: 0.4s; }
        .confetti-dot:nth-child(6) { background: #f59e0b; animation-delay: 0.5s; }
        .confetti-dot:nth-child(7) { background: #018181; animation-delay: 0.6s; }
        @keyframes confettiBounce {
            from { transform: translateY(0); }
            to { transform: translateY(-16px); }
        }

        /* ============================================
           ALERTS & INFO BOXES
           ============================================ */
        .info-box {
            padding: 14px 18px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 16px;
        }
        .info-box.info {
            background: #F0FAFA;
            border: 2px solid #cce7e7;
            color: #018181;
        }
        .info-box.warning {
            background: #FFF8F0;
            border: 2px solid #fde8cd;
            color: #b45309;
        }
        .info-box.error {
            background: #fef2f2;
            border: 2px solid #fca5a5;
            color: #dc3545;
        }
        .info-box.success {
            background: #f0fdf4;
            border: 2px solid #86efac;
            color: #059669;
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header {
                flex-direction: column;
                text-align: center;
                gap: 12px;
                padding: 24px 20px;
            }
            .header-left {
                flex-direction: column;
            }
            .header-right {
                position: static;
            }
            .step { padding: 24px 20px; }
            .progress-container { margin: 0 20px 16px 20px; }
            .month-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            .month-card { padding: 14px 10px; }
            .spotlight-optional-row {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 480px) {
            .month-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .header h1 { font-size: 22px; }
        }

        /* ============================================
           DRAFTS & PUBLISHED SECTIONS
           ============================================ */
        .drafts-section {
            max-width: 1000px;
            margin: 30px auto 0;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 35px 40px;
            backdrop-filter: blur(10px);
        }
        .drafts-section h2 {
            color: white;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 6px;
            text-align: center;
        }
        .drafts-section .section-subtitle {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
            text-align: center;
            margin-bottom: 24px;
        }
        .drafts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        .draft-card {
            background: white;
            border-radius: 12px;
            padding: 22px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .draft-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            border-color: #018181;
        }
        .draft-card h4 {
            color: #018181;
            font-size: 18px;
            margin-bottom: 8px;
        }
        .draft-card p {
            color: #6b7280;
            font-size: 13px;
            margin-bottom: 4px;
        }
        .draft-card .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .draft-card:hover .delete-btn { opacity: 0.7; }
        .draft-card .delete-btn:hover { opacity: 1; }
        .drafts-empty {
            text-align: center;
            padding: 30px;
            color: rgba(255,255,255,0.4);
            font-size: 14px;
        }
        .drafts-empty .icon { font-size: 32px; margin-bottom: 8px; }

        .published-card {
            background: #2d3748;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }
        .published-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
        }
        .published-card .card-header {
            height: 80px;
            background: #272d3f;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            opacity: 0.4;
        }
        .published-card .card-body {
            padding: 16px;
        }
        .published-card .badge {
            display: inline-block;
            background: #272d3f;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .published-card p {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
        }
        .published-card .view-btn {
            width: 100%;
            margin-top: 12px;
            padding: 10px 16px;
            background: #018181;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .published-card .view-btn:hover { background: #016666; }
        .published-card .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        .published-card:hover .delete-btn { opacity: 0.7; }

        .btn-save-draft {
            background: #059669;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-save-draft:hover { background: #047857; }

        .btn-ai-rewrite {
            background: transparent;
            color: #018181;
            border: 1.5px solid #018181;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 6px;
        }
        .btn-ai-rewrite:hover {
            background: #018181;
            color: white;
        }
        .btn-ai-rewrite:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .tone-rewrite-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
        }
        .tone-select {
            padding: 5px 10px;
            border: 1.5px solid #018181;
            border-radius: 6px;
            font-size: 12px;
            color: #272d3f;
            background: white;
            cursor: pointer;
        }
        .tone-rewrite-btn {
            background: transparent;
            color: #018181;
            border: 1.5px solid #018181;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .tone-rewrite-btn:hover {
            background: #018181;
            color: white;
        }
        .tone-rewrite-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ============================================
           MANAGE TEAM SECTION
           ============================================ */
        .team-section {
            max-width: 1000px;
            margin: 30px auto 0;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 35px 40px;
            backdrop-filter: blur(10px);
        }
        .team-section h2 {
            color: white;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 6px;
            text-align: center;
        }
        .team-section .section-subtitle {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
            text-align: center;
            margin-bottom: 24px;
        }
        .team-add-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 20px;
            align-items: end;
        }
        .team-add-form .form-col label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.7);
            margin-bottom: 4px;
        }
        .team-add-form input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .team-add-form input::placeholder { color: rgba(255,255,255,0.35); }
        .team-add-form input:focus {
            outline: none;
            border-color: #31D7CA;
            background: rgba(255,255,255,0.15);
        }
        .team-add-btn {
            background: #31D7CA;
            color: #272d3f;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.2s;
        }
        .team-add-btn:hover { background: #28c4b8; }
        .team-list {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
        }
        .team-row {
            display: grid;
            grid-template-columns: 1fr 1fr 60px;
            gap: 10px;
            padding: 12px 16px;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            font-size: 13px;
            color: rgba(255,255,255,0.85);
        }
        .team-row:last-child { border-bottom: none; }
        .team-row:hover { background: rgba(255,255,255,0.04); }
        .team-row .name { font-weight: 600; color: white; }
        .team-row .email { color: rgba(255,255,255,0.5); font-size: 12px; }
        .team-row .dept { color: rgba(255,255,255,0.5); font-size: 12px; }
        .team-remove-btn {
            background: transparent;
            border: 1px solid rgba(220,53,69,0.5);
            color: #dc3545;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .team-remove-btn:hover { background: #dc3545; color: white; border-color: #dc3545; }
        .team-count {
            text-align: center;
            color: rgba(255,255,255,0.5);
            font-size: 13px;
            margin-top: 12px;
        }
        .manage-team-link {
            color: rgba(255,255,255,0.6);
            font-size: 13px;
            cursor: pointer;
            transition: color 0.2s;
            text-decoration: none;
        }
        .manage-team-link:hover { color: #31D7CA; }
        @media (max-width: 768px) {
            .team-add-form {
                grid-template-columns: 1fr 1fr;
            }
            .team-row {
                grid-template-columns: 1fr 1fr 60px;
            }
            .team-row { grid-template-columns: 1fr 60px; }
            .team-section { padding: 24px 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- =============== HEADER =============== -->
        <div class="header">
            <div class="header-left">
                <div class="header-logo">B</div>
                <div class="header-title-group">
                    <h1>The BriteSide <span class="sparkle">&#10022;</span></h1>
                    <div class="subtitle">Internal Monthly Newsletter</div>
                </div>
            </div>
            <div class="header-right">
                <span class="header-user-greeting" id="headerUserGreeting"></span>

                <button class="start-over-btn" onclick="startOver()">Start Over</button>
            </div>
        </div>

        <!-- =============== PROGRESS BAR =============== -->
        <div class="progress-container">
            <div class="progress-text">
                <span class="progress-step-text" id="progressStepText">Step 1 of 10</span>
                <span class="progress-label" id="progressLabel">Select Month</span>
            </div>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 10%"></div>
            </div>
        </div>

        <!-- ================================================
             STEP 1: SELECT MONTH
             ================================================ -->
        <div id="step1" class="step active">
            <h2>Select Month</h2>
            <p class="step-description">Choose the month for this edition of The BriteSide.</p>

            <div id="monthGrid" class="month-grid"></div>

            <div id="birthdayCountArea" style="text-align: center; display: none;">
                <span class="birthday-count-badge" id="birthdayCountBadge"></span>
            </div>

            <!-- Newsletter Intro Line -->
            <div id="introArea" style="display: none; margin-top: 24px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                <label style="font-weight: 600; font-size: 14px; color: #272d3f; margin-bottom: 8px; display: block;">Newsletter Intro</label>
                <p style="font-size: 13px; color: #9ca3af; margin-bottom: 10px;">A short, witty opener for the top of the email.</p>
                <div id="introLoading" style="display: none; text-align: center; padding: 12px;">
                    <div class="spinner" style="display: inline-block;"></div>
                    <span style="color: #9ca3af; font-size: 13px; margin-left: 8px;">Crafting a witty intro...</span>
                </div>
                <div id="introResult" style="display: none;">
                    <textarea id="introText" rows="2" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; min-height: 50px;" placeholder="Your intro line will appear here..."></textarea>
                    <div style="text-align: right; margin-top: 6px;">
                        <button class="btn btn-secondary" onclick="generateIntro()" style="font-size: 12px; padding: 6px 14px;">Regenerate</button>
                    </div>
                </div>
            </div>

            <div class="buttons">
                <button id="step1NextBtn" class="btn" disabled onclick="goToStep(2)">Next &rarr;</button>
            </div>
        </div>

        <!-- ================================================
             STEP 2: INTRO JOKE
             ================================================ -->
        <div id="step2" class="step">
            <h2>Intro Joke</h2>
            <p class="step-description">Every BriteSide needs a good opener. Pick a theme and generate some jokes, or write your own.</p>

            <div class="theme-selector">
                <div class="form-group">
                    <label>Joke Theme</label>
                    <select id="jokeThemeSelect">
                        <option value="jewelry">Jewelry</option>
                        <option value="weddings">Weddings</option>
                        <option value="watches">Watches</option>
                        <option value="insurance">Insurance</option>
                        <option value="general office humor">General Office Humor</option>
                    </select>
                </div>
                <button class="btn" id="generateJokesBtn" onclick="generateJokes()">Generate Jokes</button>
            </div>

            <div id="jokeCardsArea" class="joke-cards" style="display: none;"></div>

            <div id="jokeRegenerateArea" style="display: none; text-align: center; margin-top: 8px;">
                <button class="btn btn-secondary" onclick="generateJokes()" style="font-size: 13px; padding: 8px 18px;">Regenerate</button>
            </div>

            <div id="jokeLoadingArea" style="display: none;">
                <div class="loading">
                    <div class="spinner"></div>
                    <p class="loading-text">Crafting some gems...</p>
                </div>
            </div>

            <label class="custom-joke-toggle">
                <input type="checkbox" id="customJokeToggle" onchange="toggleCustomJoke()">
                Write My Own
            </label>

            <div id="customJokeArea" class="custom-joke-area">
                <div class="form-group">
                    <label>Setup <span style="color:#6b7280;font-weight:400">(the question or opening line)</span></label>
                    <textarea id="customJokeSetup" rows="2" placeholder="Why did the diamond break up with the ruby?"></textarea>
                </div>
                <div class="form-group">
                    <label>Punchline <span style="color:#6b7280;font-weight:400">(readers scroll down to see this!)</span></label>
                    <textarea id="customJokePunchline" rows="2" placeholder="Because it found someone more a-pearl-ing!"></textarea>
                </div>
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="goToStep(1)">&larr; Back</button>
                <button id="step2NextBtn" class="btn" disabled onclick="goToStep(3)">Next &rarr;</button>
            </div>
        </div>

        <!-- ================================================
             STEP 3: BIRTHDAY SHOUTOUTS
             ================================================ -->
        <div id="step3" class="step">
            <h2 id="birthdayHeader">Birthday Shoutouts</h2>
            <p class="step-description" id="birthdayDescription">Celebrate this month's birthday stars!</p>

            <div id="birthdayListArea"></div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="goToStep(2)">&larr; Back</button>
                <button class="btn" onclick="goToStep(4)">Next &rarr;</button>
            </div>
        </div>

        <!-- ================================================
             STEP 4: WELCOME NEW HIRES (NEW)
             ================================================ -->
        <div id="step4" class="step">
            <h2>Welcome New Hires &#128075;</h2>
            <p class="step-description">Introduce any new team members this month.</p>

            <div class="toggle-row">
                <label class="toggle-switch">
                    <input type="checkbox" id="welcomeToggle" onchange="toggleWelcomeSection()">
                    <span class="toggle-slider"></span>
                </label>
                <div>
                    <div class="toggle-label">Any new hires to welcome?</div>
                    <div class="toggle-helper" id="welcomeToggleHelper">Skip this if no one new joined this month.</div>
                </div>
            </div>

            <div id="welcomeHiresArea" style="display: none;">
                <div id="welcomeHiresList"></div>
                <a href="javascript:void(0)" class="add-update-link" onclick="addWelcomeHire()">+ Add New Hire</a>
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="goToStep(3)">&larr; Back</button>
                <button class="btn" onclick="goToStep(5)">Next &rarr;</button>
            </div>
        </div>

        <!-- ================================================
             STEP 5: EMPLOYEE SPOTLIGHT (was 4)
             ================================================ -->
        <div id="step5" class="step">
            <h2>Employee Spotlight &#11088;</h2>
            <p class="step-description">Shine the spotlight on someone special this month. Add up to 3 spotlights.</p>

            <div id="spotlightsContainer"></div>

            <a href="javascript:void(0)" class="add-update-link" id="addSpotlightLink" onclick="addSpotlightBlock()">+ Add Another Spotlight</a>

            <div id="spotlightLoadingArea" style="display: none;">
                <div class="loading">
                    <div class="spinner"></div>
                    <p class="loading-text">Writing a spotlight that sparkles...</p>
                </div>
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="goToStep(4)">&larr; Back</button>
                <button id="step5NextBtn" class="btn" onclick="goToStep(6)">Next &rarr;</button>
            </div>
        </div>

        <!-- ================================================
             STEP 6: COMPANY UPDATES (was 5, now skippable)
             ================================================ -->
        <div id="step6" class="step">
            <h2>Company Updates</h2>
            <p class="step-description">Share what's new at BriteCo this month.</p>

            <div class="toggle-row">
                <label class="toggle-switch">
                    <input type="checkbox" id="updatesToggle" checked onchange="toggleUpdatesSection()">
                    <span class="toggle-slider"></span>
                </label>
                <div>
                    <div class="toggle-label">Include company updates?</div>
                    <div class="toggle-helper" id="updatesToggleHelper">Share what's new at BriteCo.</div>
                </div>
            </div>

            <div id="updatesFieldsArea">
            <div class="update-block" id="updateBlock1">
                <div class="update-block-header">
                    <h3>Update #1</h3>
                </div>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="update1Title" placeholder="Update title...">
                    <div class="tone-rewrite-row">
                        <select class="tone-select" id="toneUpdate1Title">
                            <option value="fun and punny">Fun & Punny</option>
                            <option value="professional" selected>Professional</option>
                            <option value="warm and engaging">Warm & Engaging</option>
                            <option value="concise">Concise</option>
                        </select>
                        <button class="tone-rewrite-btn" onclick="aiRewriteInput('update1Title', 'toneUpdate1Title')">AI Rewrite</button>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Body</label>
                    <textarea id="update1Body" rows="4" placeholder="What's the update?..."></textarea>
                    <div class="tone-rewrite-row">
                        <select class="tone-select" id="toneUpdate1Body">
                            <option value="fun and punny">Fun & Punny</option>
                            <option value="professional" selected>Professional</option>
                            <option value="warm and engaging">Warm & Engaging</option>
                            <option value="concise">Concise</option>
                        </select>
                        <button class="tone-rewrite-btn" onclick="aiRewriteWithTone('update1Body', 'toneUpdate1Body')">AI Rewrite</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Photos <span style="color:#6b7280;font-weight:400">(up to 3)</span></label>
                    <div class="update-photos" id="update1Photos"></div>
                    <button class="btn btn-secondary" style="font-size:12px;padding:6px 14px;margin-top:6px;" onclick="handleUpdatePhotoUpload(0)">+ Upload Photo</button>
                </div>
            </div>

            <div class="update-block" id="updateBlock2">
                <div class="update-block-header">
                    <h3>Update #2</h3>
                    <button class="remove-update-btn" onclick="toggleUpdate2(false)">Remove</button>
                </div>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="update2Title" placeholder="Update title...">
                    <div class="tone-rewrite-row">
                        <select class="tone-select" id="toneUpdate2Title">
                            <option value="fun and punny">Fun & Punny</option>
                            <option value="professional" selected>Professional</option>
                            <option value="warm and engaging">Warm & Engaging</option>
                            <option value="concise">Concise</option>
                        </select>
                        <button class="tone-rewrite-btn" onclick="aiRewriteInput('update2Title', 'toneUpdate2Title')">AI Rewrite</button>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Body</label>
                    <textarea id="update2Body" rows="4" placeholder="What's the update?..."></textarea>
                    <div class="tone-rewrite-row">
                        <select class="tone-select" id="toneUpdate2Body">
                            <option value="fun and punny">Fun & Punny</option>
                            <option value="professional" selected>Professional</option>
                            <option value="warm and engaging">Warm & Engaging</option>
                            <option value="concise">Concise</option>
                        </select>
                        <button class="tone-rewrite-btn" onclick="aiRewriteWithTone('update2Body', 'toneUpdate2Body')">AI Rewrite</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Photos <span style="color:#6b7280;font-weight:400">(up to 3)</span></label>
                    <div class="update-photos" id="update2Photos"></div>
                    <button class="btn btn-secondary" style="font-size:12px;padding:6px 14px;margin-top:6px;" onclick="handleUpdatePhotoUpload(1)">+ Upload Photo</button>
                </div>
            </div>

            <div class="update-block" id="updateBlock3" style="display: none;">
                <div class="update-block-header">
                    <h3>Update #3</h3>
                    <button class="remove-update-btn" onclick="toggleUpdate3(false)">Remove</button>
                </div>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="update3Title" placeholder="Update title...">
                    <div class="tone-rewrite-row">
                        <select class="tone-select" id="toneUpdate3Title">
                            <option value="fun and punny">Fun & Punny</option>
                            <option value="professional" selected>Professional</option>
                            <option value="warm and engaging">Warm & Engaging</option>
                            <option value="concise">Concise</option>
                        </select>
                        <button class="tone-rewrite-btn" onclick="aiRewriteInput('update3Title', 'toneUpdate3Title')">AI Rewrite</button>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Body</label>
                    <textarea id="update3Body" rows="4" placeholder="What's the update?..."></textarea>
                    <div class="tone-rewrite-row">
                        <select class="tone-select" id="toneUpdate3Body">
                            <option value="fun and punny">Fun & Punny</option>
                            <option value="professional" selected>Professional</option>
                            <option value="warm and engaging">Warm & Engaging</option>
                            <option value="concise">Concise</option>
                        </select>
                        <button class="tone-rewrite-btn" onclick="aiRewriteWithTone('update3Body', 'toneUpdate3Body')">AI Rewrite</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Photos <span style="color:#6b7280;font-weight:400">(up to 3)</span></label>
                    <div class="update-photos" id="update3Photos"></div>
                    <button class="btn btn-secondary" style="font-size:12px;padding:6px 14px;margin-top:6px;" onclick="handleUpdatePhotoUpload(2)">+ Upload Photo</button>
                </div>
            </div>

            <div id="addUpdateLink" class="add-update-link" style="display: none;" onclick="addNextUpdate()">
                + Add Another Update
            </div>
            </div><!-- /updatesFieldsArea -->

            <div class="buttons">
                <button class="btn btn-secondary" onclick="goToStep(5)">&larr; Back</button>
                <button class="btn-save-draft" onclick="saveDraft(); showSaveConfirm(this);">Save Draft</button>
                <button class="btn" onclick="goToStep(7)">Next &rarr;</button>
            </div>
        </div>

        <!-- ================================================
             STEP 7: MONTHLY GAME/PUZZLE (NEW)
             ================================================ -->
        <div id="step7" class="step">
            <h2>Monthly Game &#129513;</h2>
            <p class="step-description">Add a fun brain teaser for the team. The winner emails Dove for 100 BriteCo Bucks!</p>

            <div class="toggle-row">
                <label class="toggle-switch">
                    <input type="checkbox" id="gameToggle" onchange="toggleGameSection()">
                    <span class="toggle-slider"></span>
                </label>
                <div>
                    <div class="toggle-label">Include a game this month?</div>
                    <div class="toggle-helper" id="gameToggleHelper">Skip if you don't want a brain teaser.</div>
                </div>
            </div>

            <div id="gameFieldsArea" style="display: none;">
                <div class="form-group">
                    <label>Game Type</label>
                    <div class="game-type-grid" id="gameTypeGrid">
                        <div class="game-type-card" data-type="word_scramble" onclick="selectGameType('word_scramble')">
                            <span class="game-icon">&#128260;</span>
                            <span class="game-label">Word Scramble</span>
                        </div>
                        <div class="game-type-card" data-type="trivia" onclick="selectGameType('trivia')">
                            <span class="game-icon">&#128161;</span>
                            <span class="game-label">Trivia Quiz</span>
                        </div>
                        <div class="game-type-card" data-type="emoji_rebus" onclick="selectGameType('emoji_rebus')">
                            <span class="game-icon">&#128513;</span>
                            <span class="game-label">Emoji Rebus</span>
                        </div>
                        <div class="game-type-card" data-type="fill_blank" onclick="selectGameType('fill_blank')">
                            <span class="game-icon">&#9999;&#65039;</span>
                            <span class="game-label">Fill in the Blank</span>
                        </div>
                        <div class="game-type-card" data-type="hidden_word" onclick="selectGameType('hidden_word')">
                            <span class="game-icon">&#128270;</span>
                            <span class="game-label">Hidden Word</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Context / Facts to Use</label>
                    <textarea id="gameContext" rows="3" placeholder="Enter fun facts, employee info, or BriteCo trivia for the AI to use in the game..."></textarea>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
                        <div class="helper-text" style="margin:0;">The more specific, the harder it is for AI to solve!</div>
                        <button class="btn-ai-rewrite" style="white-space:nowrap;" onclick="suggestGameContext()">Suggest Ideas</button>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <button class="btn" id="generateGameBtn" onclick="generateGame()">Generate Game</button>
                    <button class="btn btn-secondary" id="regenerateGameBtn" onclick="generateGame()" style="display: none;">Regenerate</button>
                </div>

                <div id="gameLoadingArea" style="display: none;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p class="loading-text">Creating a brain teaser...</p>
                    </div>
                </div>

                <div id="gamePreviewArea" class="game-preview-area" style="display: none;">
                    <h4 style="color: #018181; margin-bottom: 12px;">Game Preview</h4>
                    <div id="gameCanvasContainer" class="game-canvas-container"></div>
                    <div id="gameTextContent"></div>
                    <div style="margin-top: 12px; padding: 10px; background: #FFF8F0; border-radius: 8px; border: 1px solid #fde8cd;">
                        <span style="font-size: 12px; font-weight: 700; color: #b45309;">ANSWER (hidden from newsletter):</span>
                        <span id="gameAnswerDisplay" style="font-size: 14px; color: #272d3f; font-weight: 600;"></span>
                    </div>
                </div>

                <div id="previousGameArea" style="margin-top: 20px; display: none;">
                    <div class="form-group">
                        <label>Previous Month's Answer (shown in newsletter)</label>
                        <input type="text" id="previousGameAnswer" placeholder="Last month's answer...">
                    </div>
                </div>
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="goToStep(6)">&larr; Back</button>
                <button class="btn" onclick="goToStep(8)">Next &rarr;</button>
            </div>
        </div>

        <!-- ================================================
             STEP 8: SPECIAL SECTION (was 6)
             ================================================ -->
        <div id="step8" class="step">
            <h2>Special Section</h2>
            <p class="step-description">Got something extra to share? Add an optional special section.</p>

            <div class="toggle-row">
                <label class="toggle-switch">
                    <input type="checkbox" id="specialSectionToggle" onchange="toggleSpecialSection()">
                    <span class="toggle-slider"></span>
                </label>
                <div>
                    <div class="toggle-label">Include a special section?</div>
                    <div class="toggle-helper" id="specialToggleHelper">Skip this if there's nothing extra this month.</div>
                </div>
            </div>

            <div class="special-section-fields" id="specialSectionFields">
                <div class="form-group">
                    <label>Placement</label>
                    <select id="specialSectionPlacement">
                        <option value="after-updates">After Updates</option>
                        <option value="before-updates">Before Updates</option>
                        <option value="after-spotlight">After Spotlight</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Section Title</label>
                    <input type="text" id="specialSectionTitle" placeholder="e.g., Team Outing Recap, Holiday Schedule...">
                    <div class="tone-rewrite-row">
                        <select class="tone-select" id="toneSpecialTitle">
                            <option value="fun and punny" selected>Fun & Punny</option>
                            <option value="professional">Professional</option>
                            <option value="warm and engaging">Warm & Engaging</option>
                            <option value="concise">Concise</option>
                        </select>
                        <button class="tone-rewrite-btn" onclick="aiRewriteInput('specialSectionTitle', 'toneSpecialTitle')">AI Rewrite</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Section Content</label>
                    <textarea id="specialSectionBody" rows="5" placeholder="Write the content for this section..."></textarea>
                    <div class="tone-rewrite-row">
                        <select class="tone-select" id="toneSpecialBody">
                            <option value="fun and punny" selected>Fun & Punny</option>
                            <option value="professional">Professional</option>
                            <option value="warm and engaging">Warm & Engaging</option>
                            <option value="concise">Concise</option>
                        </select>
                        <button class="tone-rewrite-btn" onclick="aiRewriteWithTone('specialSectionBody', 'toneSpecialBody')">AI Rewrite</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Image URL (optional)</label>
                    <input type="url" id="specialSectionImageUrl" placeholder="https://example.com/image.jpg">
                </div>

                <div id="specialSection2Block" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <div class="form-group">
                        <label>Section 2 Title</label>
                        <input type="text" id="specialSection2Title" placeholder="e.g., Fun Team Trivia...">
                        <div class="tone-rewrite-row">
                            <select class="tone-select" id="toneSpecial2Title">
                                <option value="fun and punny" selected>Fun & Punny</option>
                                <option value="professional">Professional</option>
                                <option value="warm and engaging">Warm & Engaging</option>
                                <option value="concise">Concise</option>
                            </select>
                            <button class="tone-rewrite-btn" onclick="aiRewriteInput('specialSection2Title', 'toneSpecial2Title')">AI Rewrite</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Section 2 Content</label>
                        <textarea id="specialSection2Body" rows="5" placeholder="Write the content for this section..."></textarea>
                        <div class="tone-rewrite-row">
                            <select class="tone-select" id="toneSpecial2Body">
                                <option value="fun and punny" selected>Fun & Punny</option>
                                <option value="professional">Professional</option>
                                <option value="warm and engaging">Warm & Engaging</option>
                                <option value="concise">Concise</option>
                            </select>
                            <button class="tone-rewrite-btn" onclick="aiRewriteWithTone('specialSection2Body', 'toneSpecial2Body')">AI Rewrite</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Section 2 Image URL (optional)</label>
                        <input type="url" id="specialSection2ImageUrl" placeholder="https://example.com/image.jpg">
                    </div>
                </div>

                <a href="javascript:void(0)" class="add-update-link" id="addSpecialSectionLink" onclick="toggleSpecialSection2(true)">+ Add Another Section</a>
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="goToStep(7)">&larr; Back</button>
                <button class="btn btn-green" onclick="goToStep(9)">Preview Newsletter &rarr;</button>
            </div>
        </div>

        <!-- ================================================
             STEP 9: PREVIEW EMAIL (was 7)
             ================================================ -->
        <div id="step9" class="step">
            <h2>Preview Newsletter</h2>
            <p class="step-description">Review how the newsletter will look in everyone's inbox.</p>

            <div class="subject-line-row">
                <span class="subject-line-label">Subject:</span>
                <input type="text" class="subject-line-input" id="subjectLineInput">
                <button class="subject-line-edit" title="Edit subject line" onclick="document.getElementById('subjectLineInput').focus();">&#9998;</button>
            </div>

            <div class="form-group" style="margin-bottom: 16px;">
                <label>Email Template</label>
                <select id="templateSelect" onchange="generatePreview()">
                    <option value="briteside-email.html">Classic BriteSide</option>
                    <option value="briteside-email-bold.html">Bold & Vibrant</option>
                    <option value="briteside-email-playful.html">Playful & Fun</option>
                    <option value="briteside-email-minimal.html">Modern Minimal</option>
                    <option value="briteside-email-magazine.html">Magazine Style</option>
                    <option value="briteside-email-teal.html">Teal Background</option>
                    <option value="briteside-email-teal-white.html">Teal + White</option>
                </select>
            </div>

            <div class="preview-frame" id="previewFrame">
                <div class="preview-loading" id="previewLoading">
                    <div class="spinner"></div>
                    <p class="loading-text">Rendering your newsletter...</p>
                </div>
                <iframe id="previewIframe" style="display: none;"></iframe>
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="goToStep(8)">&larr; Back</button>
                <button class="btn-save-draft" onclick="saveDraft(); showSaveConfirm(this);">Save Draft</button>
                <button class="btn btn-orange" onclick="goToStep(10)">Send Newsletter &rarr;</button>
            </div>
        </div>

        <!-- ================================================
             STEP 10: SEND NEWSLETTER (was 8)
             ================================================ -->
        <div id="step10" class="step">
            <h2>Send Newsletter</h2>
            <p class="step-description" id="sendStepDescription">Choose who gets this month's BriteSide.</p>

            <!-- SEND FORM -->
            <div id="sendFormArea">
                <div class="recipient-section">
                    <div class="recipient-header">
                        <h3>Recipients</h3>
                        <span class="recipient-count" id="recipientCountLabel">0 selected</span>
                    </div>

                    <div class="recipient-search">
                        <input type="text" id="recipientSearch" placeholder="Search by name or email..." oninput="filterRecipients()">
                    </div>

                    <div class="select-all-row" onclick="toggleSelectAll()">
                        <input type="checkbox" id="selectAllCheckbox">
                        <label for="selectAllCheckbox">Select All Employees</label>
                    </div>

                    <div class="recipient-list" id="recipientList"></div>

                    <div class="manual-recipient-row">
                        <input type="email" id="manualRecipientInput" placeholder="Add external email address...">
                        <button class="btn-small" onclick="addManualRecipient()">Add</button>
                    </div>
                </div>

                <div class="buttons">
                    <button class="btn btn-secondary" onclick="goToStep(9)">&larr; Back</button>
                    <button class="btn btn-green" id="sendBtn" disabled onclick="sendNewsletter()">
                        Send to 0 recipients
                    </button>
                </div>
            </div>

            <!-- SUCCESS SCREEN -->
            <div class="success-screen" id="successScreen">
                <div class="confetti-bar">
                    <div class="confetti-dot"></div>
                    <div class="confetti-dot"></div>
                    <div class="confetti-dot"></div>
                    <div class="confetti-dot"></div>
                    <div class="confetti-dot"></div>
                    <div class="confetti-dot"></div>
                    <div class="confetti-dot"></div>
                </div>
                <span class="success-icon">&#127881;</span>
                <div class="success-title" id="successTitle">Newsletter Sent!</div>
                <div class="success-subtitle" id="successSubtitle"></div>
                <div class="confetti-bar">
                    <div class="confetti-dot"></div>
                    <div class="confetti-dot"></div>
                    <div class="confetti-dot"></div>
                    <div class="confetti-dot"></div>
                    <div class="confetti-dot"></div>
                    <div class="confetti-dot"></div>
                    <div class="confetti-dot"></div>
                </div>
                <div class="buttons" style="justify-content: center; margin-top: 40px;">
                    <button class="btn" onclick="startOver()">Done &mdash; Start Fresh</button>
                </div>
            </div>

            <!-- SENDING INDICATOR -->
            <div id="sendingArea" style="display: none;">
                <div class="loading">
                    <div class="spinner"></div>
                    <p class="loading-text">Sending the BriteSide to your team...</p>
                </div>
            </div>
        </div>

    </div><!-- /.container -->

    <!-- ============================================
         SAVED DRAFTS SECTION
         ============================================ -->
    <div class="drafts-section" id="draftsSection">
        <h2>Saved Drafts</h2>
        <p class="section-subtitle">Resume an in-progress newsletter</p>
        <div class="drafts-grid" id="draftsGrid"></div>
        <div class="drafts-empty" id="draftsEmpty">
            <div class="icon">&#128221;</div>
            <p>No drafts in progress. Drafts save automatically as you work.</p>
        </div>
    </div>

    <!-- ============================================
         PAST NEWSLETTERS SECTION
         ============================================ -->
    <div class="drafts-section" id="publishedSection">
        <h2>Past Newsletters</h2>
        <p class="section-subtitle">Previously sent editions of The BriteSide</p>
        <div class="drafts-grid" id="publishedGrid"></div>
        <div class="drafts-empty" id="publishedEmpty">
            <div class="icon">&#128232;</div>
            <p>No published newsletters yet. They'll appear here after sending.</p>
        </div>
    </div>

    <!-- ============================================
         MANAGE TEAM SECTION
         ============================================ -->
    <div class="team-section" id="teamSection">
        <h2>Manage Team</h2>
        <p class="section-subtitle">Add new hires or remove departing team members</p>

        <div class="team-add-form">
            <div class="form-col">
                <label>Name *</label>
                <input type="text" id="addEmpName" placeholder="Full name">
            </div>
            <div class="form-col">
                <label>Email *</label>
                <input type="text" id="addEmpEmail" placeholder="email@brite.co">
            </div>
            <button class="team-add-btn" onclick="addEmployee()">+ Add</button>
        </div>

        <div class="team-list" id="teamList"></div>
        <div class="team-count" id="teamCount"></div>
    </div>

    <!-- ====================================================
         JAVASCRIPT
         ==================================================== -->
    <script>
    /* ============================================================
       STATE
       ============================================================ */
    const API_BASE = window.location.origin;
    let currentStep = 1;
    const totalSteps = 10;

    const STEP_LABELS = [
        '', // index 0 unused
        'Select Month',           // 1
        'Intro Joke',             // 2
        'Birthday Shoutouts',     // 3
        'Welcome New Hires',      // 4 (NEW)
        'Employee Spotlight',     // 5
        'Company Updates',        // 6
        'Monthly Game',           // 7 (NEW)
        'Special Section',        // 8
        'Preview Newsletter',     // 9
        'Send Newsletter'         // 10
    ];

    const MONTH_NAMES = [
        '', 'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];

    const MONTH_EMOJIS = [
        '', '&#10052;', '&#10084;', '&#127800;', '&#127793;', '&#127804;', '&#9728;',
        '&#127774;', '&#127958;', '&#127810;', '&#127875;', '&#127808;', '&#127876;'
    ];

    let selectedMonth = '';
    let selectedMonthNum = 0;
    let introLine = '';
    let joke = '';
    let jokeOptions = [];
    let selectedJokeIndex = -1;
    let birthdays = [];

    // Welcome new hires
    let welcomeEnabled = false;
    let welcomeHires = [];

    // Spotlights (1-3)
    let spotlights = [{ employee: null, fun_facts: '', blurb: '', image_url: '', video_url: '', display_title: '', qa: [{q:'',a:''},{q:'',a:''},{q:'',a:''}] }];

    // Legacy single spotlight (for backward compat)
    let spotlight = { employee: null, fun_facts: '', blurb: '', image_url: '', video_url: '' };

    let updates = [
        { title: '', body: '', photos: [] },
        { title: '', body: '', photos: [] },
        { title: '', body: '', photos: [] }
    ];
    let updatesEnabled = true;
    let showUpdate2 = true;
    let specialSection = { enabled: false, title: '', body: '', image_url: '', placement: 'after-updates' };
    let specialSections = [];
    let showSpecialSection2 = false;

    // Game
    let gameEnabled = false;
    let gameType = '';
    let gameData = null; // parsed AI response
    let gameImageUrl = '';
    let gameAnswer = '';
    let gamePreviousAnswer = '';

    let subject = '';
    let renderedHTML = '';
    let allEmployees = [];
    let manualRecipients = [];

    /* ============================================================
       AI REWRITE
       ============================================================ */
    function aiRewrite(textareaId, defaultTone) {
        var textarea = document.getElementById(textareaId);
        var content = textarea.value.trim();
        if (!content) { alert('Write something first, then AI can rewrite it.'); return; }

        var tone = defaultTone || 'fun and punny';
        textarea.disabled = true;
        // Find and disable the rewrite button
        var btn = textarea.parentElement.querySelector('.btn-ai-rewrite, .tone-rewrite-btn');
        if (btn) { btn.disabled = true; btn.textContent = 'Rewriting...'; }

        fetch(API_BASE + '/api/rewrite-content', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content, tone: tone })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            textarea.disabled = false;
            if (btn) { btn.disabled = false; btn.textContent = 'AI Rewrite'; }
            if (data.success && data.rewritten) {
                textarea.value = data.rewritten;
                showRewriteFeedback(textarea, tone);
            } else {
                alert('AI rewrite failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(function(err) {
            textarea.disabled = false;
            if (btn) { btn.disabled = false; btn.textContent = 'AI Rewrite'; }
            alert('AI rewrite failed: ' + err.message);
        });
    }

    function aiRewriteWithTone(textareaId, selectId) {
        var select = document.getElementById(selectId);
        var tone = select.value;
        aiRewrite(textareaId, tone);
    }

    function showRewriteFeedback(textarea, tone) {
        var existing = textarea.parentElement.querySelector('.rewrite-feedback');
        if (existing) existing.remove();
        var fb = document.createElement('div');
        fb.className = 'rewrite-feedback';
        fb.innerHTML = '&#10003; Rewritten with <strong>' + tone + '</strong> tone';
        fb.style.cssText = 'color: #059669; font-size: 13px; margin-top: 6px; animation: fadeIn 0.3s;';
        textarea.parentElement.appendChild(fb);
        setTimeout(function() { fb.remove(); }, 4000);
    }

    function aiRewriteInput(inputId, selectId) {
        var input = document.getElementById(inputId);
        var content = input.value.trim();
        if (!content) { alert('Write something first, then AI can rewrite it.'); return; }
        var tone = document.getElementById(selectId).value;
        input.disabled = true;
        fetch(API_BASE + '/api/rewrite-content', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content, tone: tone })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            input.disabled = false;
            if (data.success && data.rewritten) {
                input.value = data.rewritten.replace(/\n/g, ' ').trim();
            } else {
                alert('AI rewrite failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(function(err) {
            input.disabled = false;
            alert('AI rewrite failed: ' + err.message);
        });
    }

    function addNextUpdate() {
        var block2 = document.getElementById('updateBlock2');
        var block3 = document.getElementById('updateBlock3');
        if (block2.style.display === 'none') {
            toggleUpdate2(true);
        } else if (block3.style.display === 'none') {
            block3.style.display = 'block';
            document.getElementById('addUpdateLink').style.display = 'none';
        }
    }

    function toggleUpdate3(show) {
        document.getElementById('updateBlock3').style.display = show ? 'block' : 'none';
        if (!show) {
            document.getElementById('update3Title').value = '';
            document.getElementById('update3Body').value = '';
            document.getElementById('addUpdateLink').style.display = 'block';
        }
    }

    /* ============================================================
       INITIALIZATION
       ============================================================ */
    document.addEventListener('DOMContentLoaded', function() {
        renderMonthGrid();
        fetchAllEmployees();
        initAuthUser();
        loadDrafts();
        loadPublishedNewsletters();
    });

    function initAuthUser() {
        var greetingEl = document.getElementById('headerUserGreeting');
        if (window.AUTH_USER && window.AUTH_USER.name) {
            greetingEl.textContent = 'Hi, ' + window.AUTH_USER.name;
        }
        // Set BritePulse user for feedback attribution
        if (window.AUTH_USER && window.BritePulse) {
            window.BritePulse.getInstance()?.setUser({
                email: window.AUTH_USER.email,
                id: window.AUTH_USER.email
            });
        }
    }

    function fetchAllEmployees() {
        fetch(API_BASE + '/api/employees')
            .then(function(res) {
                if (!res.ok) throw new Error('Failed to fetch employees');
                return res.json();
            })
            .then(function(data) {
                allEmployees = data.employees || data || [];
                populateSpotlightDropdown();
            })
            .catch(function(err) {
                console.error('Error fetching employees:', err);
            });
    }

    /* ============================================================
       NAVIGATION
       ============================================================ */
    function goToStep(step) {
        if (step < 1 || step > totalSteps) return;

        // Before leaving current step, gather data
        collectCurrentStepData();

        // Auto-save draft silently after step 2
        if (step > 2 && selectedMonth) {
            saveDraft();
        }

        // Special actions when entering a step
        if (step === 3) {
            renderBirthdayList();
        }
        if (step === 5) {
            renderSpotlightBlocks();
        }
        if (step === 7) {
            loadPreviousGameAnswer();
            // Auto-suggest game context if field is empty
            var gameCtx = document.getElementById('gameContext');
            if (gameCtx && !gameCtx.value.trim()) {
                suggestGameContext();
            }
        }
        if (step === 9) {
            generatePreview();
        }
        if (step === 10) {
            renderRecipientList();
        }

        showStep(step);
    }

    function showStep(step) {
        // Hide all steps
        for (var i = 1; i <= totalSteps; i++) {
            var el = document.getElementById('step' + i);
            if (el) el.classList.remove('active');
        }

        // Show target step
        var targetStep = document.getElementById('step' + step);
        if (targetStep) targetStep.classList.add('active');

        currentStep = step;
        updateProgressBar();

        // Scroll to top of container
        document.querySelector('.container').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function updateProgressBar() {
        var pct = (currentStep / totalSteps) * 100;
        document.getElementById('progressBar').style.width = pct + '%';
        document.getElementById('progressStepText').textContent = 'Step ' + currentStep + ' of ' + totalSteps;
        document.getElementById('progressLabel').textContent = STEP_LABELS[currentStep] || '';
    }

    function collectCurrentStepData() {
        switch (currentStep) {
            case 1: introLine = (document.getElementById('introText').value || '').trim(); break;
            case 2: collectJokeData(); break;
            case 3: collectBirthdayData(); break;
            case 4: collectWelcomeData(); break;
            case 5: collectSpotlightsData(); break;
            case 6: collectUpdatesData(); break;
            case 7: collectGameData(); break;
            case 8: collectSpecialSectionData(); break;
            case 9: subject = document.getElementById('subjectLineInput').value; break;
        }
    }

    function startOver() {
        if (!confirm('Start over? All unsaved progress will be lost.')) return;

        selectedMonth = '';
        selectedMonthNum = 0;
        introLine = '';
        joke = '';
        jokeOptions = [];
        selectedJokeIndex = -1;
        birthdays = [];
        welcomeEnabled = false;
        welcomeHires = [];
        spotlights = [{ employee: null, fun_facts: '', blurb: '', image_url: '', video_url: '', display_title: '', qa: [{q:'',a:''},{q:'',a:''},{q:'',a:''}] }];
        spotlight = { employee: null, fun_facts: '', blurb: '', image_url: '', video_url: '' };
        updates = [{ title: '', body: '', photos: [] }, { title: '', body: '', photos: [] }, { title: '', body: '', photos: [] }];
        updatesEnabled = true;
        showUpdate2 = true;
        specialSection = { enabled: false, title: '', body: '', image_url: '', placement: 'after-updates' };
        specialSections = [];
        showSpecialSection2 = false;
        gameEnabled = false;
        gameType = '';
        gameData = null;
        gameImageUrl = '';
        gameAnswer = '';
        gamePreviousAnswer = '';
        subject = '';
        renderedHTML = '';
        manualRecipients = [];

        // Reset UI elements
        document.getElementById('step1NextBtn').disabled = true;
        document.getElementById('step2NextBtn').disabled = true;
        document.getElementById('birthdayCountArea').style.display = 'none';
        document.getElementById('introArea').style.display = 'none';
        document.getElementById('introText').value = '';
        document.getElementById('jokeCardsArea').style.display = 'none';
        document.getElementById('jokeCardsArea').innerHTML = '';
        document.getElementById('customJokeToggle').checked = false;
        document.getElementById('customJokeArea').classList.remove('visible');
        document.getElementById('customJokeSetup').value = '';
        document.getElementById('customJokePunchline').value = '';
        document.getElementById('jokeThemeSelect').selectedIndex = 0;
        document.getElementById('welcomeToggle').checked = false;
        document.getElementById('welcomeHiresArea').style.display = 'none';
        document.getElementById('welcomeHiresList').innerHTML = '';
        document.getElementById('spotlightsContainer').innerHTML = '';
        document.getElementById('updatesToggle').checked = true;
        document.getElementById('updatesFieldsArea').style.display = 'block';
        document.getElementById('update1Title').value = '';
        document.getElementById('update1Body').value = '';
        document.getElementById('update2Title').value = '';
        document.getElementById('update2Body').value = '';
        document.getElementById('updateBlock2').style.display = 'block';
        document.getElementById('addUpdateLink').style.display = 'none';
        document.getElementById('gameToggle').checked = false;
        document.getElementById('gameFieldsArea').style.display = 'none';
        document.getElementById('specialSectionToggle').checked = false;
        document.getElementById('specialSectionFields').classList.remove('visible');
        document.getElementById('specialSectionTitle').value = '';
        document.getElementById('specialSectionBody').value = '';
        document.getElementById('specialSectionImageUrl').value = '';
        document.getElementById('specialSectionPlacement').selectedIndex = 0;
        document.getElementById('specialSection2Title').value = '';
        document.getElementById('specialSection2Body').value = '';
        document.getElementById('specialSection2ImageUrl').value = '';
        document.getElementById('specialSection2Block').style.display = 'none';
        document.getElementById('addSpecialSectionLink').style.display = 'inline-flex';
        document.getElementById('sendFormArea').style.display = 'block';
        document.getElementById('successScreen').classList.remove('visible');
        document.getElementById('sendingArea').style.display = 'none';
        document.getElementById('sendStepDescription').textContent = "Choose who gets this month's BriteSide.";

        renderMonthGrid();
        showStep(1);
    }

    /* ============================================================
       STEP 1: MONTH SELECTION
       ============================================================ */
    function renderMonthGrid() {
        var grid = document.getElementById('monthGrid');
        var html = '';
        for (var i = 1; i <= 12; i++) {
            var isSelected = selectedMonthNum === i ? ' selected' : '';
            html += '<div class="month-card' + isSelected + '" data-month="' + i + '" onclick="selectMonth(' + i + ')">';
            html += '<span class="month-emoji">' + MONTH_EMOJIS[i] + '</span>';
            html += '<span class="month-name">' + MONTH_NAMES[i] + '</span>';
            html += '</div>';
        }
        grid.innerHTML = html;
    }

    function selectMonth(monthNum) {
        selectedMonthNum = monthNum;
        selectedMonth = MONTH_NAMES[monthNum];

        // Update visual selection
        var cards = document.querySelectorAll('.month-card');
        cards.forEach(function(card) {
            card.classList.remove('selected');
            if (parseInt(card.getAttribute('data-month')) === monthNum) {
                card.classList.add('selected');
            }
        });

        // Enable next button
        document.getElementById('step1NextBtn').disabled = false;

        // Set subject line default
        var year = new Date().getFullYear();
        subject = 'The BriteSide \u2014 ' + selectedMonth + ' ' + year;
        document.getElementById('subjectLineInput').value = subject;

        // Fetch birthday count
        fetchBirthdayCount(monthNum);

        // Auto-generate intro line
        generateIntro();
    }

    function fetchBirthdayCount(monthNum) {
        var countArea = document.getElementById('birthdayCountArea');
        var badge = document.getElementById('birthdayCountBadge');
        countArea.style.display = 'block';
        badge.textContent = 'Loading birthdays...';

        fetch(API_BASE + '/api/employees/birthdays?month=' + monthNum)
            .then(function(res) {
                if (!res.ok) throw new Error('Failed to fetch birthdays');
                return res.json();
            })
            .then(function(data) {
                birthdays = (data.birthdays || data || []).map(function(b) {
                    return {
                        name: b.name,
                        department: b.department,
                        birthday_day: b.birthday_day,
                        message: ''
                    };
                });
                var count = birthdays.length;
                if (count === 0) {
                    badge.textContent = 'No birthdays in ' + MONTH_NAMES[monthNum];
                } else if (count === 1) {
                    badge.innerHTML = '&#127874; 1 birthday this month!';
                } else {
                    badge.innerHTML = '&#127874; ' + count + ' birthdays this month!';
                }
            })
            .catch(function(err) {
                console.error('Error fetching birthdays:', err);
                badge.textContent = 'Could not load birthdays';
                birthdays = [];
            });
    }

    /* ============================================================
       NEWSLETTER INTRO LINE
       ============================================================ */
    function generateIntro() {
        var introArea = document.getElementById('introArea');
        var introLoading = document.getElementById('introLoading');
        var introResult = document.getElementById('introResult');

        introArea.style.display = 'block';
        introLoading.style.display = 'block';
        introResult.style.display = 'none';

        fetch(API_BASE + '/api/generate-intro', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ month: selectedMonth, year: new Date().getFullYear() })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            introLoading.style.display = 'none';
            introResult.style.display = 'block';
            if (data.success && data.intro) {
                introLine = data.intro;
                document.getElementById('introText').value = introLine;
            } else {
                document.getElementById('introText').value = '';
                document.getElementById('introText').placeholder = 'Could not generate â€” type your own!';
            }
        })
        .catch(function(err) {
            console.error('Error generating intro:', err);
            introLoading.style.display = 'none';
            introResult.style.display = 'block';
            document.getElementById('introText').value = '';
            document.getElementById('introText').placeholder = 'Could not generate â€” type your own!';
        });
    }

    /* ============================================================
       STEP 2: INTRO JOKE
       ============================================================ */
    function generateJokes() {
        var theme = document.getElementById('jokeThemeSelect').value;
        var cardsArea = document.getElementById('jokeCardsArea');
        var loadingArea = document.getElementById('jokeLoadingArea');

        cardsArea.style.display = 'none';
        cardsArea.innerHTML = '';
        loadingArea.style.display = 'block';
        document.getElementById('jokeRegenerateArea').style.display = 'none';
        jokeOptions = [];
        selectedJokeIndex = -1;

        // Uncheck custom joke toggle
        document.getElementById('customJokeToggle').checked = false;
        document.getElementById('customJokeArea').classList.remove('visible');

        fetch(API_BASE + '/api/generate-joke', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                month: selectedMonth,
                month_num: selectedMonthNum,
                theme: theme
            })
        })
        .then(function(res) {
            if (!res.ok) throw new Error('Failed to generate jokes');
            return res.json();
        })
        .then(function(data) {
            loadingArea.style.display = 'none';

            // Parse jokes â€” backend returns data.jokes as string or array
            if (data.jokes && Array.isArray(data.jokes)) {
                jokeOptions = data.jokes;
            } else if (data.jokes && typeof data.jokes === 'string') {
                jokeOptions = parseJokesFromText(data.jokes);
            } else if (data.text) {
                jokeOptions = parseJokesFromText(data.text);
            } else if (typeof data === 'string') {
                jokeOptions = parseJokesFromText(data);
            } else {
                jokeOptions = ['No jokes returned. Try a different theme!'];
            }

            renderJokeCards();
        })
        .catch(function(err) {
            loadingArea.style.display = 'none';
            console.error('Error generating jokes:', err);
            cardsArea.style.display = 'block';
            cardsArea.innerHTML = '<div class="info-box error">Failed to generate jokes. Please try again.</div>';
            alert('AI is not available. You can write your own joke using the \'Write My Own\' toggle below.');
        });
    }

    function parseJokesFromText(text) {
        // Try to parse numbered jokes like "1. ...", "2. ...", "3. ..."
        var lines = text.split('\n').filter(function(l) { return l.trim().length > 0; });
        var jokes = [];
        var currentJoke = '';

        lines.forEach(function(line) {
            var trimmed = line.trim();
            var match = trimmed.match(/^(\d+)[.)]\s*/);
            if (match) {
                if (currentJoke) jokes.push(currentJoke.trim());
                currentJoke = trimmed.replace(/^(\d+)[.)]\s*/, '');
            } else {
                currentJoke += ' ' + trimmed;
            }
        });
        if (currentJoke) jokes.push(currentJoke.trim());

        if (jokes.length === 0) {
            jokes = [text.trim()];
        }

        return jokes;
    }

    function renderJokeCards() {
        var cardsArea = document.getElementById('jokeCardsArea');
        var html = '';

        jokeOptions.forEach(function(jokeText, idx) {
            var sel = selectedJokeIndex === idx ? ' selected' : '';
            html += '<div class="joke-card' + sel + '" data-idx="' + idx + '" onclick="selectJoke(' + idx + ')">';
            html += '<div class="joke-number">' + (idx + 1) + '</div>';
            html += '<div class="joke-text">' + escapeHtml(jokeText) + '</div>';
            html += '</div>';
        });

        cardsArea.innerHTML = html;
        cardsArea.style.display = 'block';
        document.getElementById('jokeRegenerateArea').style.display = 'block';
    }

    function selectJoke(idx) {
        selectedJokeIndex = idx;
        joke = jokeOptions[idx];

        // Uncheck custom joke
        document.getElementById('customJokeToggle').checked = false;
        document.getElementById('customJokeArea').classList.remove('visible');

        // Update visual selection
        var cards = document.querySelectorAll('.joke-card');
        cards.forEach(function(card) {
            card.classList.remove('selected');
            if (parseInt(card.getAttribute('data-idx')) === idx) {
                card.classList.add('selected');
            }
        });

        updateStep2NextButton();
    }

    function toggleCustomJoke() {
        var isChecked = document.getElementById('customJokeToggle').checked;
        var area = document.getElementById('customJokeArea');

        if (isChecked) {
            area.classList.add('visible');
            // Deselect generated jokes
            selectedJokeIndex = -1;
            var cards = document.querySelectorAll('.joke-card');
            cards.forEach(function(card) { card.classList.remove('selected'); });
        } else {
            area.classList.remove('visible');
        }

        updateStep2NextButton();
    }

    function collectJokeData() {
        var isCustom = document.getElementById('customJokeToggle').checked;
        if (isCustom) {
            var setup = document.getElementById('customJokeSetup').value.trim();
            var punchline = document.getElementById('customJokePunchline').value.trim();
            joke = setup + ' | ' + punchline;
        } else if (selectedJokeIndex >= 0 && jokeOptions[selectedJokeIndex]) {
            joke = jokeOptions[selectedJokeIndex];
        }
    }

    function updateStep2NextButton() {
        var isCustom = document.getElementById('customJokeToggle').checked;
        var hasCustom = false;
        if (isCustom) {
            var setup = document.getElementById('customJokeSetup').value.trim();
            var punchline = document.getElementById('customJokePunchline').value.trim();
            hasCustom = setup.length > 0 && punchline.length > 0;
        }
        var hasJoke = selectedJokeIndex >= 0 || (isCustom && hasCustom);
        document.getElementById('step2NextBtn').disabled = !hasJoke;
    }

    // Listen for custom joke input changes
    document.addEventListener('input', function(e) {
        if (e.target && (e.target.id === 'customJokeSetup' || e.target.id === 'customJokePunchline')) {
            updateStep2NextButton();
        }
    });

    /* ============================================================
       STEP 3: BIRTHDAY SHOUTOUTS
       ============================================================ */
    function renderBirthdayList() {
        var area = document.getElementById('birthdayListArea');
        var header = document.getElementById('birthdayHeader');
        var desc = document.getElementById('birthdayDescription');

        header.innerHTML = selectedMonth + ' Birthdays &#127874;';
        desc.textContent = "Celebrate this month's birthday stars! Add a personal note if you'd like.";

        if (birthdays.length === 0) {
            area.innerHTML =
                '<div class="no-birthdays">' +
                '<span class="no-birthday-icon">&#127874;</span>' +
                '<div class="no-birthday-title">No birthdays in ' + selectedMonth + '!</div>' +
                '<div class="no-birthday-text">We\'ll celebrate next month. For now, keep being brilliant.</div>' +
                '</div>';
            return;
        }

        var html = '<div class="birthday-list">';
        birthdays.forEach(function(b, idx) {
            var dayStr = selectedMonth.substring(0, 3) + ' ' + b.birthday_day;
            html += '<div class="birthday-card">';
            html += '<div class="birthday-icon">&#127874;</div>';
            html += '<div class="birthday-info">';
            html += '<div class="birthday-name">' + escapeHtml(b.name) + '</div>';
            html += '<div class="birthday-meta">' + escapeHtml(b.department) + ' &middot; ' + dayStr + '</div>';
            html += '<textarea class="birthday-message-input" id="birthdayMsg' + idx + '" data-idx="' + idx + '" placeholder="Add a personal note..." rows="2">' + escapeHtml(b.message || '') + '</textarea>';
            html += '<button class="btn-ai-rewrite" onclick="aiRewrite(\'birthdayMsg' + idx + '\', \'warm and celebratory\')">AI Rewrite</button>';
            html += '</div>';
            html += '</div>';
        });
        html += '</div>';
        area.innerHTML = html;
    }

    function collectBirthdayData() {
        var inputs = document.querySelectorAll('.birthday-message-input');
        inputs.forEach(function(input) {
            var idx = parseInt(input.getAttribute('data-idx'));
            if (birthdays[idx]) {
                birthdays[idx].message = input.value.trim();
            }
        });
    }

    /* ============================================================
       STEP 4: WELCOME NEW HIRES
       ============================================================ */
    function toggleWelcomeSection() {
        welcomeEnabled = document.getElementById('welcomeToggle').checked;
        document.getElementById('welcomeHiresArea').style.display = welcomeEnabled ? 'block' : 'none';
        document.getElementById('welcomeToggleHelper').textContent = welcomeEnabled
            ? 'Add new team members below.'
            : 'Skip this if no one new joined this month.';
        if (welcomeEnabled && welcomeHires.length === 0) {
            addWelcomeHire();
        }
    }

    function addWelcomeHire() {
        welcomeHires.push({ name: '', role: '', fun_fact: '' });
        renderWelcomeHires();
    }

    function removeWelcomeHire(idx) {
        welcomeHires.splice(idx, 1);
        renderWelcomeHires();
    }

    function renderWelcomeHires() {
        var container = document.getElementById('welcomeHiresList');
        var html = '';
        welcomeHires.forEach(function(hire, idx) {
            html += '<div class="welcome-hire-card" data-idx="' + idx + '">';
            html += '<div class="welcome-hire-fields">';
            html += '<input type="text" placeholder="Name" value="' + escapeAttr(hire.name) + '" onchange="welcomeHires[' + idx + '].name=this.value">';
            html += '<input type="text" placeholder="Role / Title" value="' + escapeAttr(hire.role) + '" onchange="welcomeHires[' + idx + '].role=this.value">';
            html += '<div class="full-width" style="display:flex;gap:6px;align-items:center;">';
            html += '<input type="text" style="flex:1;" id="welcomeFact' + idx + '" placeholder="Fun fact (optional)" value="' + escapeAttr(hire.fun_fact) + '" onchange="welcomeHires[' + idx + '].fun_fact=this.value">';
            html += '<button class="btn-ai-rewrite" style="white-space:nowrap;flex-shrink:0;" onclick="aiRewrite(\'welcomeFact' + idx + '\', \'fun and punny\')">AI Rewrite</button>';
            html += '</div>';
            html += '</div>';
            html += '<button class="welcome-remove-btn" onclick="removeWelcomeHire(' + idx + ')">Remove</button>';
            html += '</div>';
        });
        container.innerHTML = html;
    }

    function collectWelcomeData() {
        // Data is collected via onchange handlers on the inputs
    }

    /* ============================================================
       STEP 5: EMPLOYEE SPOTLIGHT (multi, 1-3)
       ============================================================ */
    function populateSpotlightDropdown() {
        // This is now called per-block, not globally
    }

    function getEmployeeOptionsHtml(selectedIdx) {
        var html = '<option value="">-- Choose an employee --</option>';
        var sorted = allEmployees.map(function(emp, idx) { return { emp: emp, idx: idx }; });
        sorted.sort(function(a, b) {
            var aLast = a.emp.name.split(' ').slice(-1)[0].toLowerCase();
            var bLast = b.emp.name.split(' ').slice(-1)[0].toLowerCase();
            return aLast < bLast ? -1 : aLast > bLast ? 1 : 0;
        });
        sorted.forEach(function(item) {
            var label = escapeHtml(item.emp.name);
            if (item.emp.department) label += ' (' + escapeHtml(item.emp.department) + ')';
            var sel = (selectedIdx !== undefined && item.idx === selectedIdx) ? ' selected' : '';
            html += '<option value="' + item.idx + '"' + sel + '>' + label + '</option>';
        });
        return html;
    }

    function renderSpotlightBlocks() {
        var container = document.getElementById('spotlightsContainer');
        var html = '';
        spotlights.forEach(function(sp, idx) {
            var empIdx = sp.employee ? allEmployees.indexOf(sp.employee) : '';
            if (empIdx === -1 && sp.employee) {
                for (var i = 0; i < allEmployees.length; i++) {
                    if (allEmployees[i].name === sp.employee.name) { empIdx = i; break; }
                }
            }
            // Initialize Q&A if missing
            if (!sp.qa) sp.qa = [{q:'',a:''},{q:'',a:''},{q:'',a:''}];

            html += '<div class="spotlight-block" data-idx="' + idx + '">';
            html += '<div class="spotlight-block-header"><h3>Spotlight #' + (idx + 1) + '</h3>';
            if (idx > 0) html += '<button class="remove-update-btn" onclick="removeSpotlightBlock(' + idx + ')">Remove</button>';
            html += '</div>';

            // Employee select
            html += '<div class="form-group"><label>Select Employee</label>';
            html += '<select id="spotlightSelect' + idx + '" onchange="onSpotlightChange(' + idx + ')">' + getEmployeeOptionsHtml(empIdx >= 0 ? empIdx : undefined) + '</select>';
            html += '</div>';

            // Editable title (pre-filled from employee record)
            if (sp.employee) {
                var displayTitle = sp.display_title !== undefined ? sp.display_title : (sp.employee.title || '');
                html += '<div class="form-group"><label>Title / Role <span style="color:#6b7280;font-weight:400">(editable â€” shown in newsletter)</span></label>';
                html += '<input type="text" id="spotlightTitle' + idx + '" value="' + escapeAttr(displayTitle) + '" placeholder="e.g. Senior Designer" onchange="spotlights[' + idx + '].display_title=this.value">';
                html += '</div>';
            }

            // 3 Q&A pairs
            if (sp.employee) {
                html += '<div class="form-group"><label>Get to Know Them <span style="color:#6b7280;font-weight:400">(3 Q&amp;A)</span></label>';
                for (var q = 0; q < 3; q++) {
                    html += '<div style="display:flex;gap:8px;margin-bottom:8px;">';
                    html += '<input type="text" id="spotlightQ' + idx + '_' + q + '" style="flex:1" placeholder="Q' + (q+1) + ': e.g. Favorite gem?" value="' + escapeAttr(sp.qa[q].q || '') + '" onchange="spotlights[' + idx + '].qa[' + q + '].q=this.value">';
                    html += '<input type="text" id="spotlightA' + idx + '_' + q + '" style="flex:1" placeholder="Answer..." value="' + escapeAttr(sp.qa[q].a || '') + '" onchange="spotlights[' + idx + '].qa[' + q + '].a=this.value">';
                    html += '</div>';
                }
                html += '</div>';
            }

            // Fun facts (additional context for AI)
            html += '<div class="form-group"><label>Fun Facts <span style="color:#6b7280;font-weight:400">(optional â€” helps AI write the blurb)</span></label>';
            html += '<textarea id="spotlightFacts' + idx + '" rows="2" placeholder="Anything else about this person...">' + escapeHtml(sp.fun_facts || '') + '</textarea>';
            html += '<button class="btn-ai-rewrite" onclick="aiRewrite(\'spotlightFacts' + idx + '\', \'fun and punny\')">AI Rewrite</button></div>';

            // Image upload
            html += '<div class="form-group"><label>Photo</label><div class="upload-area">';
            html += '<label class="upload-btn-label"><input type="file" accept="image/*" style="display:none" onchange="handleSpotlightImageUpload(' + idx + ', this)">Upload Photo</label>';
            if (sp.image_url) {
                html += '<img src="' + escapeAttr(sp.image_url) + '" class="upload-preview-thumb">';
                html += '<button class="upload-remove" onclick="spotlights[' + idx + '].image_url=\'\';renderSpotlightBlocks()">&times;</button>';
            }
            html += '</div></div>';

            // Video upload
            html += '<div class="form-group"><label>Video (optional)</label><div class="upload-area">';
            html += '<label class="upload-btn-label"><input type="file" accept="video/*" style="display:none" onchange="handleSpotlightVideoUpload(' + idx + ', this)">Upload Video</label>';
            if (sp.video_url) {
                html += '<span style="font-size:13px;color:#059669;">Video uploaded</span>';
                html += '<button class="upload-remove" onclick="spotlights[' + idx + '].video_url=\'\';renderSpotlightBlocks()">&times;</button>';
            }
            html += '</div></div>';

            // AI generate + blurb
            html += '<button class="btn-small btn-orange" onclick="generateSpotlightFor(' + idx + ')" style="margin-bottom:12px;">AI Write Spotlight</button>';
            var hasBlurb = sp.blurb ? ' visible' : '';
            html += '<div class="ai-blurb-container' + hasBlurb + '" id="spotlightBlurbBox' + idx + '"><h4>Spotlight Blurb</h4><div class="form-group" style="margin-bottom:0;">';
            html += '<textarea id="spotlightBlurb' + idx + '" rows="4" placeholder="AI-generated blurb will appear here...">' + escapeHtml(sp.blurb || '') + '</textarea>';
            html += '<button class="btn-ai-rewrite" onclick="aiRewrite(\'spotlightBlurb' + idx + '\', \'warm and engaging\')">AI Rewrite</button></div></div>';

            html += '</div>';
        });
        container.innerHTML = html;

        // Show/hide add link
        document.getElementById('addSpotlightLink').style.display = spotlights.length >= 3 ? 'none' : 'inline-flex';
    }

    function addSpotlightBlock() {
        if (spotlights.length >= 3) return;
        spotlights.push({ employee: null, fun_facts: '', blurb: '', image_url: '', video_url: '', display_title: '', qa: [{q:'',a:''},{q:'',a:''},{q:'',a:''}] });
        renderSpotlightBlocks();
    }

    function removeSpotlightBlock(idx) {
        spotlights.splice(idx, 1);
        renderSpotlightBlocks();
    }

    function onSpotlightChange(idx) {
        var select = document.getElementById('spotlightSelect' + idx);
        var empIdx = select.value;
        if (empIdx === '' || empIdx === null) {
            spotlights[idx].employee = null;
            spotlights[idx].display_title = '';
        } else {
            var emp = allEmployees[parseInt(empIdx)];
            spotlights[idx].employee = emp;
            spotlights[idx].display_title = emp.title || '';
        }
        if (!spotlights[idx].qa) spotlights[idx].qa = [{q:'',a:''},{q:'',a:''},{q:'',a:''}];
        renderSpotlightBlocks();
    }

    function handleSpotlightImageUpload(idx, input) {
        if (!input.files || !input.files[0]) return;
        showCropperModal(input.files[0], function(url) {
            spotlights[idx].image_url = url;
            renderSpotlightBlocks();
        });
    }

    function handleSpotlightVideoUpload(idx, input) {
        if (!input.files || !input.files[0]) return;
        uploadMediaFile(input.files[0], function(url) {
            spotlights[idx].video_url = url;
            renderSpotlightBlocks();
        });
    }

    function generateSpotlightFor(idx) {
        var sp = spotlights[idx];
        if (!sp.employee) { alert('Please select an employee first.'); return; }

        // Collect current Q&A + fun facts
        var funFacts = document.getElementById('spotlightFacts' + idx).value.trim();
        sp.fun_facts = funFacts;
        var qaText = '';
        if (sp.qa) {
            sp.qa.forEach(function(pair, q) {
                var qEl = document.getElementById('spotlightQ' + idx + '_' + q);
                var aEl = document.getElementById('spotlightA' + idx + '_' + q);
                if (qEl) sp.qa[q].q = qEl.value.trim();
                if (aEl) sp.qa[q].a = aEl.value.trim();
                if (sp.qa[q].q && sp.qa[q].a) {
                    qaText += sp.qa[q].q + ' ' + sp.qa[q].a + '. ';
                }
            });
        }
        var combinedFacts = (funFacts + ' ' + qaText).trim();

        var loadingArea = document.getElementById('spotlightLoadingArea');
        loadingArea.style.display = 'block';

        var titleEl = document.getElementById('spotlightTitle' + idx);
        var displayTitle = titleEl ? titleEl.value.trim() : (sp.employee.title || '');

        fetch(API_BASE + '/api/generate-spotlight', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: sp.employee.name,
                title: displayTitle,
                department: sp.employee.department || '',
                fun_facts: combinedFacts
            })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            loadingArea.style.display = 'none';
            sp.blurb = data.blurb || data.text || data.spotlight || '';
            renderSpotlightBlocks();
        })
        .catch(function(err) {
            loadingArea.style.display = 'none';
            alert('Failed to generate spotlight. Please try again.');
        });
    }

    function collectSpotlightsData() {
        spotlights.forEach(function(sp, idx) {
            var factsEl = document.getElementById('spotlightFacts' + idx);
            var blurbEl = document.getElementById('spotlightBlurb' + idx);
            var titleEl = document.getElementById('spotlightTitle' + idx);
            if (factsEl) sp.fun_facts = factsEl.value.trim();
            if (blurbEl) sp.blurb = blurbEl.value.trim();
            if (titleEl) sp.display_title = titleEl.value.trim();
            // Collect Q&A
            if (!sp.qa) sp.qa = [{q:'',a:''},{q:'',a:''},{q:'',a:''}];
            for (var q = 0; q < 3; q++) {
                var qEl = document.getElementById('spotlightQ' + idx + '_' + q);
                var aEl = document.getElementById('spotlightA' + idx + '_' + q);
                if (qEl) sp.qa[q].q = qEl.value.trim();
                if (aEl) sp.qa[q].a = aEl.value.trim();
            }
        });
        // Backward compat
        if (spotlights.length > 0 && spotlights[0].employee) {
            spotlight = {
                employee: spotlights[0].employee,
                fun_facts: spotlights[0].fun_facts,
                blurb: spotlights[0].blurb,
                image_url: spotlights[0].image_url,
                video_url: spotlights[0].video_url
            };
        }
    }

    // Legacy function name
    function collectSpotlightData() { collectSpotlightsData(); }

    /* ============================================================
       STEP 5: COMPANY UPDATES
       ============================================================ */
    function toggleUpdate2(show) {
        showUpdate2 = show;
        document.getElementById('updateBlock2').style.display = show ? 'block' : 'none';
        if (!show) {
            document.getElementById('update2Title').value = '';
            document.getElementById('update2Body').value = '';
            toggleUpdate3(false);
            document.getElementById('addUpdateLink').style.display = 'inline-flex';
        } else {
            // Show add link for update 3 if update 3 is not visible
            var block3 = document.getElementById('updateBlock3');
            document.getElementById('addUpdateLink').style.display = (block3.style.display === 'none') ? 'inline-flex' : 'none';
        }
    }

    function handleUpdatePhotoUpload(updateIndex) {
        var photosEl = document.getElementById('update' + (updateIndex + 1) + 'Photos');
        var existing = (updates[updateIndex] && updates[updateIndex].photos) || [];
        if (existing.length >= 3) {
            alert('Maximum 3 photos per update.');
            return;
        }
        var input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = function() {
            if (!input.files[0]) return;
            showCropperModal(input.files[0], function(url) {
                if (!updates[updateIndex].photos) updates[updateIndex].photos = [];
                updates[updateIndex].photos.push(url);
                renderUpdatePhotos(updateIndex);
            });
        };
        input.click();
    }

    function renderUpdatePhotos(updateIndex) {
        var photosEl = document.getElementById('update' + (updateIndex + 1) + 'Photos');
        var photos = (updates[updateIndex] && updates[updateIndex].photos) || [];
        var html = '';
        photos.forEach(function(url, i) {
            html += '<div style="display:inline-block;position:relative;margin:4px;">' +
                '<img src="' + url + '" style="width:80px;height:80px;object-fit:cover;border-radius:6px;border:2px solid #e5e7eb;">' +
                '<button onclick="removeUpdatePhoto(' + updateIndex + ',' + i + ')" style="position:absolute;top:-6px;right:-6px;background:#ef4444;color:white;border:none;border-radius:50%;width:20px;height:20px;font-size:12px;cursor:pointer;line-height:20px;">&times;</button>' +
                '</div>';
        });
        photosEl.innerHTML = html;
    }

    function removeUpdatePhoto(updateIndex, photoIndex) {
        if (updates[updateIndex] && updates[updateIndex].photos) {
            updates[updateIndex].photos.splice(photoIndex, 1);
            renderUpdatePhotos(updateIndex);
        }
    }

    function collectUpdatesData() {
        updates[0].title = document.getElementById('update1Title').value.trim();
        updates[0].body = document.getElementById('update1Body').value.trim();
        if (showUpdate2) {
            updates[1].title = document.getElementById('update2Title').value.trim();
            updates[1].body = document.getElementById('update2Body').value.trim();
        } else {
            updates[1] = { title: '', body: '', photos: [] };
        }
        // Update 3
        var block3 = document.getElementById('updateBlock3');
        if (block3 && block3.style.display !== 'none') {
            if (!updates[2]) updates[2] = { title: '', body: '', photos: [] };
            updates[2].title = document.getElementById('update3Title').value.trim();
            updates[2].body = document.getElementById('update3Body').value.trim();
        } else {
            updates[2] = { title: '', body: '', photos: [] };
        }
    }

    /* ============================================================
       STEP 6: SPECIAL SECTION
       ============================================================ */
    function toggleSpecialSection() {
        var isEnabled = document.getElementById('specialSectionToggle').checked;
        var fields = document.getElementById('specialSectionFields');
        var helper = document.getElementById('specialToggleHelper');

        specialSection.enabled = isEnabled;

        if (isEnabled) {
            fields.classList.add('visible');
            helper.textContent = 'Great \u2014 fill in the details below.';
        } else {
            fields.classList.remove('visible');
            helper.textContent = "Skip this if there's nothing extra this month.";
        }
    }

    function toggleSpecialSection2(show) {
        showSpecialSection2 = show;
        document.getElementById('specialSection2Block').style.display = show ? 'block' : 'none';
        document.getElementById('addSpecialSectionLink').style.display = show ? 'none' : 'inline-flex';
    }

    function collectSpecialSectionData() {
        var isEnabled = document.getElementById('specialSectionToggle').checked;
        specialSection.enabled = isEnabled;
        if (isEnabled) {
            specialSection.title = document.getElementById('specialSectionTitle').value.trim();
            specialSection.body = document.getElementById('specialSectionBody').value.trim();
            specialSection.image_url = document.getElementById('specialSectionImageUrl').value.trim();
            specialSection.placement = document.getElementById('specialSectionPlacement').value;
        } else {
            specialSection.title = '';
            specialSection.body = '';
            specialSection.image_url = '';
            specialSection.placement = 'after-updates';
        }

        // Collect additional special sections
        specialSections = [];
        if (isEnabled) {
            specialSections.push({
                title: specialSection.title,
                body: specialSection.body,
                image_url: specialSection.image_url
            });
            if (showSpecialSection2) {
                var s2Title = document.getElementById('specialSection2Title').value.trim();
                var s2Body = document.getElementById('specialSection2Body').value.trim();
                var s2Image = document.getElementById('specialSection2ImageUrl').value.trim();
                if (s2Title || s2Body) {
                    specialSections.push({ title: s2Title, body: s2Body, image_url: s2Image });
                }
            }
        }
    }

    /* ============================================================
       STEP 9: PREVIEW
       ============================================================ */
    function generatePreview() {
        // Collect all data first
        collectCurrentStepData();

        var previewLoading = document.getElementById('previewLoading');
        var previewIframe = document.getElementById('previewIframe');

        previewLoading.style.display = 'block';
        previewIframe.style.display = 'none';

        // Build the payload
        var payload = buildNewsletterPayload();

        fetch(API_BASE + '/api/render-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(function(res) {
            if (!res.ok) throw new Error('Failed to render email');
            return res.json();
        })
        .then(function(data) {
            renderedHTML = data.html || data.rendered_html || '';
            previewLoading.style.display = 'none';
            previewIframe.style.display = 'block';
            previewIframe.srcdoc = renderedHTML;

            // Auto-resize iframe after content loads
            previewIframe.onload = function() {
                try {
                    var iframeDoc = previewIframe.contentDocument || previewIframe.contentWindow.document;
                    var height = iframeDoc.documentElement.scrollHeight || iframeDoc.body.scrollHeight;
                    previewIframe.style.height = Math.max(height + 40, 600) + 'px';
                } catch(e) {
                    previewIframe.style.height = '800px';
                }
            };
        })
        .catch(function(err) {
            previewLoading.style.display = 'none';
            console.error('Error rendering preview:', err);
            previewIframe.style.display = 'block';
            previewIframe.srcdoc = '<div style="padding:40px;font-family:sans-serif;text-align:center;color:#dc3545;">' +
                '<h2>Preview Error</h2><p>Could not render the newsletter preview. Please go back and check your content, or try again.</p>' +
                '<p style="color:#999;font-size:13px;">' + escapeHtml(err.message) + '</p></div>';
        });
    }

    function buildNewsletterPayload() {
        // Build the updates array, filtering empty ones
        var activeUpdates = [];
        if (updatesEnabled) {
            if (updates[0].title || updates[0].body) activeUpdates.push(updates[0]);
            if (showUpdate2 && (updates[1].title || updates[1].body)) activeUpdates.push(updates[1]);
            var block3 = document.getElementById('updateBlock3');
            if (block3 && block3.style.display !== 'none' && (updates[2].title || updates[2].body)) activeUpdates.push(updates[2]);
        }

        // Build birthday data
        var birthdayData = birthdays.map(function(b) {
            return { name: b.name, department: b.department, birthday_day: b.birthday_day, message: b.message || '' };
        });

        // Build spotlights array for rendering
        var spotlightsData = spotlights.filter(function(sp) { return sp.employee; }).map(function(sp) {
            var qaFiltered = (sp.qa || []).filter(function(pair) { return pair.q && pair.a; });
            return {
                name: sp.employee.name,
                title: sp.display_title || sp.employee.title || '',
                department: sp.employee.department || '',
                fun_facts: sp.fun_facts,
                blurb: sp.blurb,
                image_url: sp.image_url,
                video_url: sp.video_url,
                qa: qaFiltered
            };
        });

        // Legacy single spotlight
        var spotlightData = spotlightsData.length > 0 ? spotlightsData[0] : null;

        // Build special section
        var specialData = null;
        if (specialSection.enabled && (specialSection.title || specialSection.body)) {
            specialData = {
                title: specialSection.title, body: specialSection.body,
                image_url: specialSection.image_url || '', placement: specialSection.placement || 'after-updates'
            };
        }

        // Build game data
        var gamePayload = null;
        if (gameEnabled && (gameData || gameImageUrl)) {
            var textContent = '';
            if (gameData && gameType === 'trivia' && gameData.questions) {
                textContent = gameData.questions.map(function(q, i) {
                    var opts = q.options ? q.options.map(function(o, j) { return ['A','B','C','D'][j] + ') ' + o; }).join('<br>') : '';
                    return '<strong>' + (i+1) + '. ' + q.q + '</strong><br>' + opts;
                }).join('<br><br>');
            } else if (gameData && gameType === 'fill_blank' && gameData.blanks) {
                textContent = gameData.blanks.map(function(b, i) {
                    return '<strong>' + (i+1) + '.</strong> ' + b.sentence;
                }).join('<br>');
            }

            gamePayload = {
                content: textContent,
                image_url: gameImageUrl,
                answer: gameAnswer,
                previous_answer: gamePreviousAnswer
            };
        }

        // Template selection
        var templateSelect = document.getElementById('templateSelect');
        var templateVal = templateSelect ? templateSelect.value : 'briteside-email.html';

        return {
            month: selectedMonth,
            month_num: selectedMonthNum,
            year: new Date().getFullYear(),
            intro_line: introLine,
            joke: joke,
            birthdays: birthdayData,
            spotlight: spotlightData,
            spotlights: spotlightsData,
            updates: activeUpdates,
            updates_enabled: updatesEnabled,
            welcome_hires: welcomeEnabled ? welcomeHires.filter(function(h) { return h.name; }) : [],
            welcome_enabled: welcomeEnabled,
            game: gamePayload,
            special_section: specialData,
            special_sections: specialSections.length > 0 ? specialSections : null,
            subject: subject,
            template: templateVal
        };
    }

    /* ============================================================
       STEP 10: SEND
       ============================================================ */
    function renderRecipientList() {
        var listEl = document.getElementById('recipientList');
        var html = '';

        // Sort employees by last name
        var sorted = allEmployees.map(function(emp, idx) { return { emp: emp, idx: idx }; });
        sorted.sort(function(a, b) {
            var aLast = a.emp.name.split(' ').slice(-1)[0].toLowerCase();
            var bLast = b.emp.name.split(' ').slice(-1)[0].toLowerCase();
            return aLast < bLast ? -1 : aLast > bLast ? 1 : 0;
        });
        sorted.forEach(function(item) {
            html += '<div class="recipient-item">';
            html += '<input type="checkbox" class="emp-checkbox" data-idx="' + item.idx + '" data-email="' + escapeAttr(item.emp.email) + '" onchange="updateRecipientCount()">';
            html += '<span class="recipient-name">' + escapeHtml(item.emp.name) + '</span>';
            html += '<span class="recipient-email">' + escapeHtml(item.emp.email) + '</span>';
            html += '</div>';
        });

        // Manual recipients
        manualRecipients.forEach(function(email, idx) {
            html += '<div class="recipient-item">';
            html += '<input type="checkbox" class="manual-checkbox" data-manual-idx="' + idx + '" data-email="' + escapeAttr(email) + '" checked onchange="updateRecipientCount()">';
            html += '<span class="recipient-name">Manual</span>';
            html += '<span class="recipient-email">' + escapeHtml(email) + '</span>';
            html += '</div>';
        });

        listEl.innerHTML = html;
        document.getElementById('selectAllCheckbox').checked = false;
        updateRecipientCount();
    }

    function toggleSelectAll() {
        var selectAllCb = document.getElementById('selectAllCheckbox');
        // Toggle the checkbox itself if clicked outside the input
        var isChecked = !selectAllCb.checked;
        selectAllCb.checked = isChecked;

        var checkboxes = document.querySelectorAll('.emp-checkbox, .manual-checkbox');
        checkboxes.forEach(function(cb) {
            cb.checked = isChecked;
        });
        updateRecipientCount();
    }

    // Handle the checkbox click directly so we don't double-toggle
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'selectAllCheckbox') {
            var isChecked = e.target.checked;
            var checkboxes = document.querySelectorAll('.emp-checkbox, .manual-checkbox');
            checkboxes.forEach(function(cb) {
                cb.checked = isChecked;
            });
            updateRecipientCount();
        }
    });

    function addManualRecipient() {
        var input = document.getElementById('manualRecipientInput');
        var email = input.value.trim();
        if (!email || !isValidEmail(email)) {
            alert('Please enter a valid email address.');
            return;
        }

        // Check for duplicates
        var allEmails = allEmployees.map(function(e) { return e.email.toLowerCase(); });
        var manualLower = manualRecipients.map(function(e) { return e.toLowerCase(); });

        if (allEmails.indexOf(email.toLowerCase()) !== -1 || manualLower.indexOf(email.toLowerCase()) !== -1) {
            alert('This email is already in the recipient list.');
            return;
        }

        manualRecipients.push(email);
        input.value = '';
        renderRecipientList();

        // Check the newly added manual recipient
        var manualCbs = document.querySelectorAll('.manual-checkbox');
        if (manualCbs.length > 0) {
            manualCbs[manualCbs.length - 1].checked = true;
        }
        updateRecipientCount();
    }

    function updateRecipientCount() {
        var checked = getSelectedRecipientEmails();
        var count = checked.length;
        var label = document.getElementById('recipientCountLabel');
        var btn = document.getElementById('sendBtn');

        label.textContent = count + ' selected';
        btn.textContent = 'Send to ' + count + ' recipient' + (count !== 1 ? 's' : '');
        btn.disabled = count === 0;
    }

    function getSelectedRecipientEmails() {
        var emails = [];
        var checkboxes = document.querySelectorAll('.emp-checkbox:checked, .manual-checkbox:checked');
        checkboxes.forEach(function(cb) {
            var email = cb.getAttribute('data-email');
            if (email) emails.push(email);
        });
        return emails;
    }

    function sendNewsletter() {
        var recipients = getSelectedRecipientEmails();
        if (recipients.length === 0) {
            alert('Please select at least one recipient.');
            return;
        }

        // Get current subject
        subject = document.getElementById('subjectLineInput').value.trim() || subject;

        var sendFormArea = document.getElementById('sendFormArea');
        var sendingArea = document.getElementById('sendingArea');

        sendFormArea.style.display = 'none';
        sendingArea.style.display = 'block';

        fetch(API_BASE + '/api/send-newsletter', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                recipients: recipients,
                subject: subject,
                html: renderedHTML,
                month: selectedMonth,
                month_num: selectedMonthNum,
                year: new Date().getFullYear()
            })
        })
        .then(function(res) {
            if (!res.ok) throw new Error('Failed to send newsletter');
            return res.json();
        })
        .then(function(data) {
            sendingArea.style.display = 'none';
            showSuccessScreen(recipients.length);
            // Auto-publish draft after successful send
            publishDraft();
        })
        .catch(function(err) {
            sendingArea.style.display = 'none';
            sendFormArea.style.display = 'block';
            console.error('Error sending newsletter:', err);
            alert('Failed to send newsletter: ' + err.message + '\nPlease try again.');
        });
    }

    function showSuccessScreen(recipientCount) {
        var sendFormArea = document.getElementById('sendFormArea');
        var successScreen = document.getElementById('successScreen');
        var sendStepDesc = document.getElementById('sendStepDescription');

        sendFormArea.style.display = 'none';
        sendStepDesc.style.display = 'none';

        document.getElementById('successTitle').textContent = 'Newsletter Sent!';
        document.getElementById('successSubtitle').textContent =
            'The BriteSide was delivered to ' + recipientCount + ' ' +
            (recipientCount === 1 ? 'person' : 'people') + '. Nice work!';

        successScreen.classList.add('visible');

        // Hide progress bar for celebration
        document.getElementById('progressStepText').textContent = 'Complete!';
        document.getElementById('progressLabel').textContent = 'Newsletter delivered';
        document.getElementById('progressBar').style.width = '100%';
    }

    /* ============================================================
       UTILITY FUNCTIONS
       ============================================================ */
    function escapeHtml(str) {
        if (!str) return '';
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    function escapeAttr(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;')
                  .replace(/"/g, '&quot;')
                  .replace(/'/g, '&#39;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;');
    }

    function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    /* ============================================================
       DRAFT SAVE / LOAD / DELETE
       ============================================================ */
    function saveDraft() {
        if (!selectedMonth) return;
        collectCurrentStepData();
        var userEmail = (window.AUTH_USER && window.AUTH_USER.email) || 'unknown';
        fetch(API_BASE + '/api/save-draft', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                month: selectedMonth,
                year: new Date().getFullYear(),
                currentStep: currentStep,
                joke: joke,
                jokeOptions: jokeOptions,
                selectedJokeIndex: selectedJokeIndex,
                birthdays: birthdays,
                spotlight: spotlight,
                spotlights: spotlights,
                updates: updates,
                updatesEnabled: updatesEnabled,
                welcomeHires: welcomeHires,
                welcomeEnabled: welcomeEnabled,
                game: {
                    enabled: gameEnabled,
                    type: gameType,
                    data: gameData,
                    imageUrl: gameImageUrl,
                    answer: gameAnswer,
                    previousAnswer: gamePreviousAnswer
                },
                specialSection: specialSection,
                specialSections: specialSections,
                subject: subject,
                savedBy: userEmail
            })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            console.log('[Draft] Saved:', data);
            loadDrafts();
        })
        .catch(function(err) { console.error('[Draft] Save failed:', err); });
    }

    function showSaveConfirm(btn) {
        var orig = btn.textContent;
        btn.textContent = 'Saved!';
        btn.style.background = '#22c55e';
        setTimeout(function() { btn.textContent = orig; btn.style.background = ''; }, 2000);
    }

    function loadDrafts() {
        fetch(API_BASE + '/api/list-drafts')
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success && data.drafts && data.drafts.length > 0) {
                var grid = document.getElementById('draftsGrid');
                document.getElementById('draftsEmpty').style.display = 'none';
                grid.innerHTML = '';
                data.drafts.forEach(function(d) {
                    var monthCap = d.month ? d.month.charAt(0).toUpperCase() + d.month.slice(1) : '?';
                    var savedBy = d.lastSavedBy || 'unknown';
                    var savedAt = d.lastSavedAt ? new Date(d.lastSavedAt).toLocaleString('en-US', {
                        timeZone: 'America/Chicago', month: 'short', day: 'numeric',
                        hour: 'numeric', minute: '2-digit', hour12: true
                    }) : '';
                    var card = document.createElement('div');
                    card.className = 'draft-card';
                    card.innerHTML =
                        '<button class="delete-btn" onclick="event.stopPropagation();if(confirm(\'Delete draft for ' + monthCap + ' ' + d.year + '?\'))deleteDraft(\'' + d.filename + '\')">&times;</button>' +
                        '<h4>' + monthCap + ' ' + d.year + '</h4>' +
                        '<p>Step ' + (d.currentStep || '?') + ' of 10</p>' +
                        '<p>By: ' + escapeHtml(savedBy) + '</p>' +
                        '<p>' + savedAt + ' CT</p>';
                    card.onclick = function() { resumeDraft(d.filename); };
                    grid.appendChild(card);
                });
            } else {
                document.getElementById('draftsEmpty').style.display = 'block';
                document.getElementById('draftsGrid').innerHTML = '';
            }
        })
        .catch(function(err) { console.error('[Drafts] Load failed:', err); });
    }

    function resumeDraft(filename) {
        fetch(API_BASE + '/api/load-draft?file=' + encodeURIComponent(filename))
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (!data.success || !data.draft) { alert('Failed to load draft'); return; }
            var d = data.draft;

            // Restore state
            selectedMonth = d.month || '';
            selectedMonthNum = MONTH_NAMES.indexOf(selectedMonth.charAt(0).toUpperCase() + selectedMonth.slice(1));
            joke = d.joke || '';
            jokeOptions = d.jokeOptions || [];
            selectedJokeIndex = d.selectedJokeIndex != null ? d.selectedJokeIndex : -1;
            birthdays = d.birthdays || [];
            spotlight = d.spotlight || { employee: null, fun_facts: '', blurb: '', image_url: '', video_url: '' };
            updates = d.updates || [{ title: '', body: '' }, { title: '', body: '' }];
            specialSection = d.specialSection || { enabled: false, title: '', body: '', image_url: '', placement: 'after-updates' };
            specialSections = d.specialSections || [];
            subject = d.subject || '';

            // Restore new fields
            // Spotlights (backward compat: wrap old single spotlight in array)
            if (d.spotlights && d.spotlights.length > 0) {
                spotlights = d.spotlights;
                // Ensure qa arrays exist on each spotlight
                spotlights.forEach(function(sp) {
                    if (!sp.qa) sp.qa = [{q:'',a:''},{q:'',a:''},{q:'',a:''}];
                    if (sp.display_title === undefined && sp.employee) sp.display_title = sp.employee.title || '';
                });
            } else if (d.spotlight && d.spotlight.employee) {
                spotlights = [d.spotlight];
                spotlights[0].qa = spotlights[0].qa || [{q:'',a:''},{q:'',a:''},{q:'',a:''}];
                spotlights[0].display_title = spotlights[0].display_title || spotlights[0].employee.title || '';
            } else {
                spotlights = [{ employee: null, fun_facts: '', blurb: '', image_url: '', video_url: '', display_title: '', qa: [{q:'',a:''},{q:'',a:''},{q:'',a:''}] }];
            }

            // Welcome hires
            welcomeEnabled = d.welcomeEnabled || false;
            welcomeHires = d.welcomeHires || [];

            // Updates enabled
            updatesEnabled = d.updatesEnabled !== undefined ? d.updatesEnabled : true;

            // Game
            if (d.game) {
                gameEnabled = d.game.enabled || false;
                gameType = d.game.type || '';
                gameData = d.game.data || null;
                gameImageUrl = d.game.imageUrl || '';
                gameAnswer = d.game.answer || '';
                gamePreviousAnswer = d.game.previousAnswer || '';
            }

            // Restore UI - month selection
            var monthCards = document.querySelectorAll('.month-card');
            for (var i = 0; i < monthCards.length; i++) {
                monthCards[i].classList.remove('selected');
                if (monthCards[i].getAttribute('data-month') === selectedMonth.toLowerCase() ||
                    monthCards[i].textContent.toLowerCase().indexOf(selectedMonth.toLowerCase()) !== -1) {
                    monthCards[i].classList.add('selected');
                }
            }
            document.getElementById('step1NextBtn').disabled = !selectedMonth;

            // Restore joke
            if (joke) {
                document.getElementById('step2NextBtn').disabled = false;
            }

            // Restore welcome hires UI
            if (welcomeEnabled) {
                document.getElementById('welcomeToggle').checked = true;
                document.getElementById('welcomeHiresArea').style.display = 'block';
                renderWelcomeHires();
            }

            // Restore updates UI
            if (!updatesEnabled) {
                document.getElementById('updatesToggle').checked = false;
                document.getElementById('updatesFieldsArea').style.display = 'none';
            }

            // Restore update fields
            if (updates[0]) {
                document.getElementById('update1Title').value = updates[0].title || '';
                document.getElementById('update1Body').value = updates[0].body || '';
            }
            if (updates[1]) {
                document.getElementById('update2Title').value = updates[1].title || '';
                document.getElementById('update2Body').value = updates[1].body || '';
            }

            // Restore game UI
            if (gameEnabled) {
                document.getElementById('gameToggle').checked = true;
                document.getElementById('gameFieldsArea').style.display = 'block';
                if (gameType) {
                    var gameCards = document.querySelectorAll('.game-type-card');
                    gameCards.forEach(function(c) {
                        c.classList.remove('selected');
                        if (c.getAttribute('data-type') === gameType) c.classList.add('selected');
                    });
                }
                if (gameData || gameImageUrl) renderGamePreview();
                if (gamePreviousAnswer) {
                    var prevInput = document.getElementById('gamePreviousAnswer');
                    if (prevInput) prevInput.value = gamePreviousAnswer;
                }
            }

            // Restore special section
            if (specialSection.enabled) {
                document.getElementById('specialSectionToggle').checked = true;
                document.getElementById('specialSectionFields').classList.add('visible');
                document.getElementById('specialSectionTitle').value = specialSection.title || '';
                document.getElementById('specialSectionBody').value = specialSection.body || '';
                document.getElementById('specialSectionImageUrl').value = specialSection.image_url || '';
                if (specialSection.placement) {
                    document.getElementById('specialSectionPlacement').value = specialSection.placement;
                }
                // Restore second special section if present
                if (specialSections.length > 1) {
                    toggleSpecialSection2(true);
                    document.getElementById('specialSection2Title').value = specialSections[1].title || '';
                    document.getElementById('specialSection2Body').value = specialSections[1].body || '';
                    document.getElementById('specialSection2ImageUrl').value = specialSections[1].image_url || '';
                }
            }

            // Restore subject
            if (subject) {
                document.getElementById('subjectLineInput').value = subject;
            }

            // Navigate to saved step
            var step = d.currentStep || 1;
            if (step === 3) renderBirthdayList();
            if (step === 5) renderSpotlightBlocks();
            if (step === 9) generatePreview();
            if (step === 10) renderRecipientList();
            showStep(step);
        })
        .catch(function(err) {
            console.error('[Draft] Load failed:', err);
            alert('Error loading draft');
        });
    }

    function deleteDraft(filename) {
        fetch(API_BASE + '/api/delete-draft', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ file: filename })
        })
        .then(function() { loadDrafts(); })
        .catch(function(err) { console.error('[Draft] Delete failed:', err); });
    }

    function publishDraft() {
        var year = new Date().getFullYear();
        var userPrefix = ((window.AUTH_USER && window.AUTH_USER.email) || 'unknown').split('@')[0].replace(/\./g, '-');
        fetch(API_BASE + '/api/publish-draft', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ file: 'drafts/' + selectedMonth.toLowerCase() + '-' + year + '-' + userPrefix + '.json' })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                loadDrafts();
                loadPublishedNewsletters();
            }
        })
        .catch(function(err) { console.error('[Publish] Failed:', err); });
    }

    /* ============================================================
       PUBLISHED NEWSLETTERS
       ============================================================ */
    function loadPublishedNewsletters() {
        fetch(API_BASE + '/api/list-published')
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success && data.newsletters && data.newsletters.length > 0) {
                var grid = document.getElementById('publishedGrid');
                document.getElementById('publishedEmpty').style.display = 'none';
                grid.innerHTML = '';
                data.newsletters.forEach(function(n) {
                    var monthCap = n.month ? n.month.charAt(0).toUpperCase() + n.month.slice(1) : '?';
                    var savedBy = n.lastSavedBy || 'unknown';
                    var savedAt = n.lastSavedAt ? new Date(n.lastSavedAt).toLocaleString('en-US', {
                        timeZone: 'America/Chicago', month: 'short', day: 'numeric',
                        hour: 'numeric', minute: '2-digit', hour12: true
                    }) : '';
                    var card = document.createElement('div');
                    card.className = 'published-card';
                    card.innerHTML =
                        '<button class="delete-btn" onclick="event.stopPropagation();if(confirm(\'Delete this published newsletter?\'))deletePublished(\'' + n.filename + '\')">&times;</button>' +
                        '<div class="card-header">&#128232;</div>' +
                        '<div class="card-body">' +
                            '<span class="badge">' + monthCap + ' ' + n.year + '</span>' +
                            '<p>' + escapeHtml(savedBy) + ' &middot; ' + savedAt + ' CT</p>' +
                            '<button class="view-btn" onclick="event.stopPropagation();viewPublished(\'' + n.filename + '\')">View Newsletter</button>' +
                        '</div>';
                    grid.appendChild(card);
                });
            } else {
                document.getElementById('publishedEmpty').style.display = 'block';
                document.getElementById('publishedGrid').innerHTML = '';
            }
        })
        .catch(function(err) { console.error('[Published] Load failed:', err); });
    }

    function viewPublished(filename) {
        fetch(API_BASE + '/api/load-published?file=' + encodeURIComponent(filename))
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (!data.success || !data.draft) { alert('Failed to load newsletter'); return; }
            var d = data.draft;

            // Restore state from published data
            selectedMonth = d.month || '';
            selectedMonthNum = MONTH_NAMES.indexOf(selectedMonth.charAt(0).toUpperCase() + selectedMonth.slice(1));
            joke = d.joke || '';
            birthdays = d.birthdays || [];
            spotlight = d.spotlight || { employee: null, fun_facts: '', blurb: '', image_url: '', video_url: '' };
            updates = d.updates || [{ title: '', body: '' }, { title: '', body: '' }];
            specialSection = d.specialSection || { enabled: false, title: '', body: '', image_url: '', placement: 'after-updates' };
            specialSections = d.specialSections || [];
            subject = d.subject || '';

            // Restore new fields
            if (d.spotlights && d.spotlights.length > 0) {
                spotlights = d.spotlights;
                spotlights.forEach(function(sp) {
                    if (!sp.qa) sp.qa = [{q:'',a:''},{q:'',a:''},{q:'',a:''}];
                    if (sp.display_title === undefined && sp.employee) sp.display_title = sp.employee.title || '';
                });
            } else if (d.spotlight && d.spotlight.employee) {
                var s = d.spotlight;
                s.qa = s.qa || [{q:'',a:''},{q:'',a:''},{q:'',a:''}];
                s.display_title = s.display_title || s.employee.title || '';
                spotlights = [s];
            }
            welcomeEnabled = d.welcomeEnabled || false;
            welcomeHires = d.welcomeHires || [];
            updatesEnabled = d.updatesEnabled !== undefined ? d.updatesEnabled : true;
            if (d.game) {
                gameEnabled = d.game.enabled || false;
                gameType = d.game.type || '';
                gameData = d.game.data || null;
                gameImageUrl = d.game.imageUrl || '';
                gameAnswer = d.game.answer || '';
                gamePreviousAnswer = d.game.previousAnswer || '';
            }

            if (subject) document.getElementById('subjectLineInput').value = subject;

            // Go directly to preview (now step 9)
            generatePreview();
            showStep(9);
        })
        .catch(function(err) {
            alert('Error loading published newsletter');
        });
    }

    function deletePublished(filename) {
        fetch(API_BASE + '/api/delete-published', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ file: filename })
        })
        .then(function() { loadPublishedNewsletters(); })
        .catch(function(err) { console.error('[Published] Delete failed:', err); });
    }

    /* ============================================================
       MANAGE TEAM
       ============================================================ */
    function renderTeamList() {
        var listEl = document.getElementById('teamList');
        var countEl = document.getElementById('teamCount');

        if (!allEmployees || allEmployees.length === 0) {
            listEl.innerHTML = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.4);font-size:14px;">No employees loaded</div>';
            countEl.textContent = '';
            return;
        }

        var html = '';
        allEmployees.forEach(function(emp) {
            html += '<div class="team-row">';
            html += '<div class="name">' + escapeHtml(emp.name) + '</div>';
            html += '<div class="email">' + escapeHtml(emp.email) + '</div>';
            html += '<button class="team-remove-btn" onclick="removeEmployee(\'' + escapeAttr(emp.email) + '\', \'' + escapeAttr(emp.name) + '\')">Remove</button>';
            html += '</div>';
        });

        listEl.innerHTML = html;
        countEl.textContent = allEmployees.length + ' team member' + (allEmployees.length !== 1 ? 's' : '');
    }

    function addEmployee() {
        var name = document.getElementById('addEmpName').value.trim();
        var email = document.getElementById('addEmpEmail').value.trim();
        if (!name || !email) {
            alert('Name and email are required.');
            return;
        }

        fetch(API_BASE + '/api/employees/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, email: email, department: '', title: '' })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                document.getElementById('addEmpName').value = '';
                document.getElementById('addEmpEmail').value = '';
                // Refresh employee list
                fetchAllEmployees();
            } else {
                alert('Error: ' + (data.error || 'Could not add employee'));
            }
        })
        .catch(function(err) { alert('Error adding employee: ' + err.message); });
    }

    function removeEmployee(email, name) {
        if (!confirm('Remove ' + name + ' from the team list?')) return;

        fetch(API_BASE + '/api/employees/remove', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                fetchAllEmployees();
            } else {
                alert('Error: ' + (data.error || 'Could not remove employee'));
            }
        })
        .catch(function(err) { alert('Error removing employee: ' + err.message); });
    }

    // Override fetchAllEmployees to also render the team list
    var _origFetchAllEmployees = fetchAllEmployees;
    fetchAllEmployees = function() {
        fetch(API_BASE + '/api/employees')
            .then(function(res) {
                if (!res.ok) throw new Error('Failed to fetch employees');
                return res.json();
            })
            .then(function(data) {
                allEmployees = data.employees || data || [];
                populateSpotlightDropdown();
                renderTeamList();
            })
            .catch(function(err) {
                console.error('Error fetching employees:', err);
            });
    };

    // Initial render of team list (employees already fetched on DOMContentLoaded)
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(renderTeamList, 1000);
    });

    /* ============================================================
       UPDATES TOGGLE
       ============================================================ */
    function toggleUpdatesSection() {
        updatesEnabled = document.getElementById('updatesToggle').checked;
        document.getElementById('updatesFieldsArea').style.display = updatesEnabled ? 'block' : 'none';
        document.getElementById('updatesToggleHelper').textContent = updatesEnabled
            ? 'Share what\'s new at BriteCo.'
            : 'No updates this month â€” that\'s OK!';
    }

    /* ============================================================
       MEDIA UPLOAD HELPERS
       ============================================================ */
    function uploadMediaFile(file, callback) {
        var formData = new FormData();
        formData.append('file', file);

        fetch(API_BASE + '/api/upload-media', {
            method: 'POST',
            body: formData
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success && data.url) {
                callback(data.url);
            } else {
                alert('Upload failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(function(err) {
            alert('Upload failed: ' + err.message);
        });
    }

    function showCropperModal(file, callback) {
        // Create modal overlay
        var overlay = document.createElement('div');
        overlay.className = 'cropper-modal-overlay';

        var modal = document.createElement('div');
        modal.className = 'cropper-modal-content';
        modal.innerHTML = '<h3>Crop Image</h3>' +
            '<div class="cropper-aspect-row">' +
            '<button class="cropper-aspect-btn active" data-ratio="1" onclick="setCropperAspect(this, 1)">1:1</button>' +
            '<button class="cropper-aspect-btn" data-ratio="1.777" onclick="setCropperAspect(this, 16/9)">16:9</button>' +
            '<button class="cropper-aspect-btn" data-ratio="0" onclick="setCropperAspect(this, NaN)">Free</button>' +
            '</div>' +
            '<div id="cropperImageContainer"><img id="cropperImage" style="max-width:100%;"></div>' +
            '<div class="cropper-modal-actions">' +
            '<button class="btn btn-secondary" id="cropperCancelBtn">Cancel</button>' +
            '<button class="btn" id="cropperConfirmBtn">Crop & Upload</button>' +
            '</div>';

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        var img = modal.querySelector('#cropperImage');
        var reader = new FileReader();
        reader.onload = function(e) {
            img.src = e.target.result;
            // Initialize Cropper.js after image loads
            img.onload = function() {
                if (typeof Cropper !== 'undefined') {
                    window._activeCropper = new Cropper(img, {
                        aspectRatio: 1,
                        viewMode: 1,
                        responsive: true,
                    });
                }
            };
        };
        reader.readAsDataURL(file);

        modal.querySelector('#cropperCancelBtn').onclick = function() {
            if (window._activeCropper) { window._activeCropper.destroy(); window._activeCropper = null; }
            overlay.remove();
        };

        modal.querySelector('#cropperConfirmBtn').onclick = function() {
            if (window._activeCropper) {
                var canvas = window._activeCropper.getCroppedCanvas({ maxWidth: 800, maxHeight: 800 });
                canvas.toBlob(function(blob) {
                    window._activeCropper.destroy();
                    window._activeCropper = null;
                    overlay.remove();
                    // Upload the cropped blob
                    var croppedFile = new File([blob], 'cropped-image.jpg', { type: 'image/jpeg' });
                    uploadMediaFile(croppedFile, callback);
                }, 'image/jpeg', 0.9);
            } else {
                // No cropper, just upload original
                overlay.remove();
                uploadMediaFile(file, callback);
            }
        };
    }

    window.setCropperAspect = function(btn, ratio) {
        var buttons = btn.parentElement.querySelectorAll('.cropper-aspect-btn');
        buttons.forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        if (window._activeCropper) {
            window._activeCropper.setAspectRatio(ratio);
        }
    };

    /* ============================================================
       GAME SECTION (Step 7)
       ============================================================ */
    function toggleGameSection() {
        gameEnabled = document.getElementById('gameToggle').checked;
        document.getElementById('gameFieldsArea').style.display = gameEnabled ? 'block' : 'none';
        document.getElementById('gameToggleHelper').textContent = gameEnabled
            ? 'Pick a game type and generate!'
            : 'Skip if you don\'t want a brain teaser.';
    }

    function selectGameType(type) {
        gameType = type;
        var cards = document.querySelectorAll('.game-type-card');
        cards.forEach(function(c) {
            c.classList.remove('selected');
            if (c.getAttribute('data-type') === type) c.classList.add('selected');
        });
    }

    function suggestGameContext() {
        // Build context from current newsletter content
        var ideas = [];

        // From spotlight Q&A and facts
        spotlights.forEach(function(sp) {
            if (sp.employee) {
                ideas.push(sp.employee.name + ' - ' + (sp.display_title || sp.employee.title || ''));
                if (sp.fun_facts) ideas.push(sp.fun_facts);
                if (sp.qa) {
                    sp.qa.forEach(function(pair) {
                        if (pair.q && pair.a) ideas.push(pair.q + ': ' + pair.a);
                    });
                }
            }
        });

        // From birthdays
        birthdays.forEach(function(b) {
            if (b.name) ideas.push(b.name + ' has a birthday this month');
        });

        // From welcome hires
        welcomeHires.forEach(function(h) {
            if (h.name) {
                var line = 'New hire: ' + h.name;
                if (h.role) line += ' (' + h.role + ')';
                if (h.fun_fact) line += ' - ' + h.fun_fact;
                ideas.push(line);
            }
        });

        // From updates
        updates.forEach(function(u) {
            if (u.title) ideas.push('Company update: ' + u.title);
        });

        var textarea = document.getElementById('gameContext');

        // Also fetch past newsletters for additional context
        fetch(API_BASE + '/api/list-published')
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (!data.success || !data.newsletters || data.newsletters.length === 0) {
                    textarea.value = ideas.join('\n');
                    return;
                }
                // Load the most recent published newsletter
                var latest = data.newsletters[0];
                return fetch(API_BASE + '/api/load-published?file=' + encodeURIComponent(latest.filename))
                    .then(function(res) { return res.json(); })
                    .then(function(pubData) {
                        if (!pubData.success) return;
                        var d = pubData.data || pubData;
                        ideas.push('');
                        ideas.push('--- From past newsletter (' + (latest.month || '') + ' ' + (latest.year || '') + ') ---');

                        // Past spotlight data
                        var pastSpotlights = d.spotlights || [];
                        if (!pastSpotlights.length && d.spotlight && d.spotlight.name) pastSpotlights = [d.spotlight];
                        pastSpotlights.forEach(function(ps) {
                            if (ps.name) ideas.push('Past spotlight: ' + ps.name + (ps.title ? ' (' + ps.title + ')' : ''));
                            if (ps.fun_facts) ideas.push(ps.fun_facts);
                            if (ps.blurb) ideas.push(ps.blurb);
                            if (ps.qa) {
                                ps.qa.forEach(function(pair) {
                                    if (pair.q && pair.a) ideas.push(pair.q + ': ' + pair.a);
                                });
                            }
                        });

                        // Past birthdays
                        var pastBdays = d.birthdays || [];
                        pastBdays.forEach(function(b) {
                            if (b.name) ideas.push('Past birthday: ' + b.name);
                        });

                        // Past updates
                        var pastUpdates = d.updates || [];
                        pastUpdates.forEach(function(u) {
                            if (u && u.title) ideas.push('Past update: ' + u.title);
                        });

                        textarea.value = ideas.join('\n');
                    });
            })
            .catch(function() {
                // If fetch fails, just use current content
                textarea.value = ideas.join('\n');
            });
    }

    function generateGame() {
        if (!gameType) { alert('Please select a game type first.'); return; }

        var context = document.getElementById('gameContext').value.trim();
        var loadingArea = document.getElementById('gameLoadingArea');
        var previewArea = document.getElementById('gamePreviewArea');

        loadingArea.style.display = 'block';
        previewArea.style.display = 'none';

        fetch(API_BASE + '/api/generate-game', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: gameType,
                context: context,
                month: selectedMonth
            })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            loadingArea.style.display = 'none';
            if (!data.success) { alert('Failed: ' + (data.error || 'Unknown error')); return; }

            try {
                gameData = JSON.parse(data.game_content);
            } catch(e) {
                gameData = { text: data.game_content };
            }

            gameAnswer = gameData.answer || gameData.word || '';
            renderGamePreview();
            document.getElementById('regenerateGameBtn').style.display = 'inline-flex';
        })
        .catch(function(err) {
            loadingArea.style.display = 'none';
            alert('Failed to generate game: ' + err.message);
        });
    }

    function renderGamePreview() {
        var previewArea = document.getElementById('gamePreviewArea');
        var canvasContainer = document.getElementById('gameCanvasContainer');
        var textContent = document.getElementById('gameTextContent');
        var answerDisplay = document.getElementById('gameAnswerDisplay');

        previewArea.style.display = 'block';
        canvasContainer.innerHTML = '';
        textContent.innerHTML = '';

        var isVisualGame = ['word_scramble', 'hidden_word', 'emoji_rebus'].indexOf(gameType) !== -1;

        if (isVisualGame && gameData) {
            // Render on canvas
            var canvas = document.createElement('canvas');
            canvas.width = 500;
            canvas.height = 400;
            var ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, 500, 400);

            if (gameType === 'word_scramble') {
                ctx.fillStyle = '#272D3F';
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('WORD SCRAMBLE', 250, 40);
                ctx.font = 'bold 48px monospace';
                ctx.fillStyle = '#018181';
                var scrambled = gameData.scrambled || '';
                // Space out letters
                var spaced = scrambled.split('').join('  ');
                ctx.fillText(spaced, 250, 200);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#6b7280';
                ctx.fillText(gameData.hint || '', 250, 300);
            } else if (gameType === 'hidden_word') {
                ctx.fillStyle = '#272D3F';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('FIND THE HIDDEN WORD', 250, 30);
                if (gameData.grid && Array.isArray(gameData.grid)) {
                    ctx.font = 'bold 22px monospace';
                    ctx.fillStyle = '#272D3F';
                    var gridSize = gameData.grid.length;
                    var cellSize = Math.min(30, 350 / gridSize);
                    var startX = 250 - (gridSize * cellSize / 2);
                    var startY = 60;
                    gameData.grid.forEach(function(row, r) {
                        row.forEach(function(letter, c) {
                            ctx.fillText(letter, startX + c * cellSize + cellSize/2, startY + r * cellSize + cellSize * 0.7);
                        });
                    });
                }
                ctx.font = '14px Arial';
                ctx.fillStyle = '#6b7280';
                ctx.fillText('Hint: ' + (gameData.hint || ''), 250, 380);
            } else if (gameType === 'emoji_rebus') {
                ctx.fillStyle = '#272D3F';
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('EMOJI REBUS', 250, 40);
                ctx.font = '60px serif';
                ctx.fillText(gameData.emojis || '', 250, 200);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#6b7280';
                ctx.fillText('Hint: ' + (gameData.hint || ''), 250, 320);
            }

            canvasContainer.appendChild(canvas);

            // Auto-upload canvas as PNG to GCS
            canvas.toBlob(function(blob) {
                var file = new File([blob], 'game-' + gameType + '.png', { type: 'image/png' });
                uploadMediaFile(file, function(url) {
                    gameImageUrl = url;
                });
            }, 'image/png');

        } else if (gameData) {
            // Text-based game (trivia, fill_blank)
            var html = '';
            if (gameType === 'trivia' && gameData.questions) {
                gameData.questions.forEach(function(q, i) {
                    html += '<div style="margin-bottom:16px;">';
                    html += '<p style="font-weight:700;color:#272d3f;">' + (i+1) + '. ' + escapeHtml(q.q) + '</p>';
                    if (q.options) {
                        q.options.forEach(function(opt, j) {
                            var letters = ['A', 'B', 'C', 'D'];
                            html += '<p style="margin-left:20px;color:#555;">' + letters[j] + ') ' + escapeHtml(opt) + '</p>';
                        });
                    }
                    html += '</div>';
                });
                gameAnswer = gameData.questions.map(function(q) { return q.answer; }).join(', ');
            } else if (gameType === 'fill_blank' && gameData.blanks) {
                gameData.blanks.forEach(function(b, i) {
                    html += '<p style="margin-bottom:8px;color:#272d3f;"><strong>' + (i+1) + '.</strong> ' + escapeHtml(b.sentence) + '</p>';
                });
                gameAnswer = gameData.blanks.map(function(b) { return b.answer; }).join(', ');
            } else if (gameData.text) {
                html = '<p style="white-space:pre-wrap;">' + escapeHtml(gameData.text) + '</p>';
            }
            textContent.innerHTML = html;
        }

        answerDisplay.textContent = gameAnswer;
    }

    function loadPreviousGameAnswer() {
        if (!selectedMonthNum) return;
        fetch(API_BASE + '/api/get-previous-game?month=' + selectedMonthNum + '&year=' + new Date().getFullYear())
        .then(function(res) { return res.json(); })
        .then(function(data) {
            var area = document.getElementById('previousGameArea');
            if (data.game && data.game.answer) {
                gamePreviousAnswer = data.game.answer;
                document.getElementById('previousGameAnswer').value = gamePreviousAnswer;
                area.style.display = 'block';
            } else {
                area.style.display = 'block'; // still show input for manual entry
            }
        })
        .catch(function() {});
    }

    function collectGameData() {
        if (gameEnabled) {
            var prevAnswer = document.getElementById('previousGameAnswer');
            if (prevAnswer) gamePreviousAnswer = prevAnswer.value.trim();
        }
    }

    /* ============================================================
       RECIPIENT SEARCH FILTER
       ============================================================ */
    function filterRecipients() {
        var term = document.getElementById('recipientSearch').value.toLowerCase().trim();
        var items = document.querySelectorAll('.recipient-item');
        items.forEach(function(item) {
            var name = item.querySelector('.recipient-name');
            var email = item.querySelector('.recipient-email');
            var nameText = name ? name.textContent.toLowerCase() : '';
            var emailText = email ? email.textContent.toLowerCase() : '';
            if (!term || nameText.indexOf(term) !== -1 || emailText.indexOf(term) !== -1) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
</body>
</html>
